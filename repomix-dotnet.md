## File: C:\Users\Agony\Documents\MyProjects\Cinema\.gitignore
`$lang
**/bin/
**/obj/

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\Cinema.sln
`$lang

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 17
VisualStudioVersion = 17.0.31903.59
MinimumVisualStudioVersion = 10.0.40219.1
Project("{2150E333-8FDC-42A3-9474-1A3956D46DE8}") = "src", "src", "{827E0CD3-B72D-47B6-A68D-7590B98EB39B}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "Domain", "src\Domain\Domain.csproj", "{AC55E81F-14CD-4CEC-8501-91F0A502532F}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "Application", "src\Application\Application.csproj", "{B2FEBCFD-2283-4E05-B4B3-35B535FF6235}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "Infrastructure", "src\Infrastructure\Infrastructure.csproj", "{361348E9-4D69-4507-83B3-7E227F4BE231}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "Api", "src\Api\Api.csproj", "{7DB04699-700F-434C-99C4-4ABED968C08C}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|Any CPU = Debug|Any CPU
		Debug|x64 = Debug|x64
		Debug|x86 = Debug|x86
		Release|Any CPU = Release|Any CPU
		Release|x64 = Release|x64
		Release|x86 = Release|x86
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{AC55E81F-14CD-4CEC-8501-91F0A502532F}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{AC55E81F-14CD-4CEC-8501-91F0A502532F}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{AC55E81F-14CD-4CEC-8501-91F0A502532F}.Debug|x64.ActiveCfg = Debug|Any CPU
		{AC55E81F-14CD-4CEC-8501-91F0A502532F}.Debug|x64.Build.0 = Debug|Any CPU
		{AC55E81F-14CD-4CEC-8501-91F0A502532F}.Debug|x86.ActiveCfg = Debug|Any CPU
		{AC55E81F-14CD-4CEC-8501-91F0A502532F}.Debug|x86.Build.0 = Debug|Any CPU
		{AC55E81F-14CD-4CEC-8501-91F0A502532F}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{AC55E81F-14CD-4CEC-8501-91F0A502532F}.Release|Any CPU.Build.0 = Release|Any CPU
		{AC55E81F-14CD-4CEC-8501-91F0A502532F}.Release|x64.ActiveCfg = Release|Any CPU
		{AC55E81F-14CD-4CEC-8501-91F0A502532F}.Release|x64.Build.0 = Release|Any CPU
		{AC55E81F-14CD-4CEC-8501-91F0A502532F}.Release|x86.ActiveCfg = Release|Any CPU
		{AC55E81F-14CD-4CEC-8501-91F0A502532F}.Release|x86.Build.0 = Release|Any CPU
		{B2FEBCFD-2283-4E05-B4B3-35B535FF6235}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{B2FEBCFD-2283-4E05-B4B3-35B535FF6235}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{B2FEBCFD-2283-4E05-B4B3-35B535FF6235}.Debug|x64.ActiveCfg = Debug|Any CPU
		{B2FEBCFD-2283-4E05-B4B3-35B535FF6235}.Debug|x64.Build.0 = Debug|Any CPU
		{B2FEBCFD-2283-4E05-B4B3-35B535FF6235}.Debug|x86.ActiveCfg = Debug|Any CPU
		{B2FEBCFD-2283-4E05-B4B3-35B535FF6235}.Debug|x86.Build.0 = Debug|Any CPU
		{B2FEBCFD-2283-4E05-B4B3-35B535FF6235}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{B2FEBCFD-2283-4E05-B4B3-35B535FF6235}.Release|Any CPU.Build.0 = Release|Any CPU
		{B2FEBCFD-2283-4E05-B4B3-35B535FF6235}.Release|x64.ActiveCfg = Release|Any CPU
		{B2FEBCFD-2283-4E05-B4B3-35B535FF6235}.Release|x64.Build.0 = Release|Any CPU
		{B2FEBCFD-2283-4E05-B4B3-35B535FF6235}.Release|x86.ActiveCfg = Release|Any CPU
		{B2FEBCFD-2283-4E05-B4B3-35B535FF6235}.Release|x86.Build.0 = Release|Any CPU
		{361348E9-4D69-4507-83B3-7E227F4BE231}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{361348E9-4D69-4507-83B3-7E227F4BE231}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{361348E9-4D69-4507-83B3-7E227F4BE231}.Debug|x64.ActiveCfg = Debug|Any CPU
		{361348E9-4D69-4507-83B3-7E227F4BE231}.Debug|x64.Build.0 = Debug|Any CPU
		{361348E9-4D69-4507-83B3-7E227F4BE231}.Debug|x86.ActiveCfg = Debug|Any CPU
		{361348E9-4D69-4507-83B3-7E227F4BE231}.Debug|x86.Build.0 = Debug|Any CPU
		{361348E9-4D69-4507-83B3-7E227F4BE231}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{361348E9-4D69-4507-83B3-7E227F4BE231}.Release|Any CPU.Build.0 = Release|Any CPU
		{361348E9-4D69-4507-83B3-7E227F4BE231}.Release|x64.ActiveCfg = Release|Any CPU
		{361348E9-4D69-4507-83B3-7E227F4BE231}.Release|x64.Build.0 = Release|Any CPU
		{361348E9-4D69-4507-83B3-7E227F4BE231}.Release|x86.ActiveCfg = Release|Any CPU
		{361348E9-4D69-4507-83B3-7E227F4BE231}.Release|x86.Build.0 = Release|Any CPU
		{7DB04699-700F-434C-99C4-4ABED968C08C}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{7DB04699-700F-434C-99C4-4ABED968C08C}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{7DB04699-700F-434C-99C4-4ABED968C08C}.Debug|x64.ActiveCfg = Debug|Any CPU
		{7DB04699-700F-434C-99C4-4ABED968C08C}.Debug|x64.Build.0 = Debug|Any CPU
		{7DB04699-700F-434C-99C4-4ABED968C08C}.Debug|x86.ActiveCfg = Debug|Any CPU
		{7DB04699-700F-434C-99C4-4ABED968C08C}.Debug|x86.Build.0 = Debug|Any CPU
		{7DB04699-700F-434C-99C4-4ABED968C08C}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{7DB04699-700F-434C-99C4-4ABED968C08C}.Release|Any CPU.Build.0 = Release|Any CPU
		{7DB04699-700F-434C-99C4-4ABED968C08C}.Release|x64.ActiveCfg = Release|Any CPU
		{7DB04699-700F-434C-99C4-4ABED968C08C}.Release|x64.Build.0 = Release|Any CPU
		{7DB04699-700F-434C-99C4-4ABED968C08C}.Release|x86.ActiveCfg = Release|Any CPU
		{7DB04699-700F-434C-99C4-4ABED968C08C}.Release|x86.Build.0 = Release|Any CPU
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(NestedProjects) = preSolution
		{AC55E81F-14CD-4CEC-8501-91F0A502532F} = {827E0CD3-B72D-47B6-A68D-7590B98EB39B}
		{B2FEBCFD-2283-4E05-B4B3-35B535FF6235} = {827E0CD3-B72D-47B6-A68D-7590B98EB39B}
		{361348E9-4D69-4507-83B3-7E227F4BE231} = {827E0CD3-B72D-47B6-A68D-7590B98EB39B}
		{7DB04699-700F-434C-99C4-4ABED968C08C} = {827E0CD3-B72D-47B6-A68D-7590B98EB39B}
	EndGlobalSection
EndGlobal

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Api\Api.csproj
`$lang
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="FluentResults" Version="4.0.0" />
    <PackageReference Include="Microsoft.AspNetCore.Authentication.JwtBearer" Version="9.0.11" />
    <PackageReference Include="Microsoft.AspNetCore.OpenApi" Version="9.0.8" />
    <PackageReference Include="Microsoft.EntityFrameworkCore" Version="9.0.9" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="9.0.9">
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <PackageReference Include="Npgsql.EntityFrameworkCore.PostgreSQL" Version="9.0.4" />
    <PackageReference Include="Swashbuckle.AspNetCore" Version="9.0.6" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\Application\Application.csproj" />
    <ProjectReference Include="..\Infrastructure\Infrastructure.csproj" />
  </ItemGroup>

</Project>

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Api\Api.http
`$lang
@Api_HostAddress = http://localhost:5141

GET {{Api_HostAddress}}/weatherforecast/
Accept: application/json

###

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Api\appsettings.Development.json
`$lang
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  
  "ConnectionStrings": {
    "DefaultConnection": "Host=172.23.160.1;Port=5432;Database=CinemaDb;Username=postgres;Password=agony"
  },

  "JwtSettings": {
    "Secret": "super-secret-key-at-least-32-characters-long",
    "Issuer": "Cinema.Api",
    "Audience": "Cinema.User",
    "ExpiryMinutes": 60
  },

  "CinemaSettings": {
    "OpeningHour": 9,
    "ClosingHour": 23,
    "MinMinutesAddSession": 60,
    "MaxDaysAddSession": 10
  }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Api\appsettings.json
`$lang
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Api\ExceptionHandlerMiddleware.cs
`$lang
using Cinema.Domain.Exceptions;

namespace Cinema.Api;

public class ExceptionHandlerMiddleware
{
    private RequestDelegate _next;

    public ExceptionHandlerMiddleware(RequestDelegate next)
    {
        _next = next;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        try
        {
            await _next(context);
        }
        catch (DomainArgumentException ex)
        {
            await HandleExceptionAsync(context, ex, 400, ex.Title);
        }
        catch (Exception ex)
        {
            await HandleExceptionAsync(context, ex, 500, "Internal Server Error");
        }
    }
    private static Task HandleExceptionAsync(HttpContext context, Exception exception, int statusCode, string title)
    {
        context.Response.ContentType = "application/json";
        context.Response.StatusCode = statusCode;

        var response = new
        {
            Status = statusCode,
            Title = title,
            Detail = exception.Message,
            TimeStamp = DateTime.UtcNow
        };

        return context.Response.WriteAsJsonAsync(response);
    }
}


`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Api\Program.cs
`$lang
using Cinema.Infrastructure;
using Microsoft.EntityFrameworkCore;
using System.Text.Json.Serialization;
using Cinema.Application.Abstractions.IRepositories;
using Cinema.Application.Abstractions;
using Cinema.Application.Services;
using Cinema.Application.Services.IServices;
using Cinema.Infrastructure.Security;
using Cinema.Application.MappingProfiles;
using Cinema.Infrastructure.Repositories;
using Cinema.Infrastructure.Security.Auth;
using Cinema.Domain.Policies;
using Cinema.Domain.Abstractions;
using Cinema.Infrastructure.Time;
using Microsoft.Extensions.Options;
using Cinema.Api;
using Cinema.Api.Extensions;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

builder.Services.AddDbContext<AppDbContext>(options =>
        options.UseNpgsql(
            builder.Configuration.GetConnectionString("DefaultConnection")));


builder.Services.AddControllers()
                .AddJsonOptions(options =>
                        {
                            options.JsonSerializerOptions.Converters
                                .Add(new JsonStringEnumConverter());
                        });

builder.Services.AddAutoMapper(cfg => { }, typeof(UserProfile).Assembly);
builder.Services.AddSingleton<IPasswordHasher, PasswordHasher>();
builder.Services.AddScoped<IUnitOfWork, UnitOfWork>();
builder.Services.AddScoped<IJwtTokenGenerator, JwtTokenGenerator>();

builder.Services.AddScoped<IUserRepository, UserRepository>();
builder.Services.AddScoped<IBookingRepository, BookingRepository>();
builder.Services.AddScoped<ISessionRepository, SessionRepository>();
builder.Services.AddScoped<ISeatRepository, SeatRepository>();
builder.Services.AddScoped<IFilmRepository, FilmRepository>();
builder.Services.AddScoped<IHallRepository, HallRepository>();

builder.Services.AddScoped<IUserService, UserService>();
builder.Services.AddScoped<ISessionService, SessionService>();
builder.Services.AddScoped<IBookingService, BookingService>();
builder.Services.AddScoped<IFilmService, FilmService>();
builder.Services.AddScoped<IHallService, HallService>();
builder.Services.AddScoped<ISeatService, SeatService>();

if (builder.Environment.IsDevelopment())
{
    builder.Services.AddSingleton<IClock>(_ => new FixedTime(new DateTime(2026, 1, 15, 9, 0, 0)));
}
else
{
    builder.Services.AddSingleton<IClock, SystemClock>();
}

builder.Services.Configure<JwtSettings>(
        builder.Configuration.GetSection("JwtSettings"));

builder.Services.Configure<Cinema.Application.Helpers.CinemaSettings>(
        builder.Configuration.GetSection("CinemaSettings"));

builder.Services.AddSingleton<ICinemaSettings>(sp =>
        sp.GetRequiredService<IOptions<Cinema.Application.Helpers.CinemaSettings>>().Value);

builder.Services.AddSingleton<SessionPolicy>();

builder.Services.AddAuth(builder.Configuration);

var app = builder.Build();

app.UseMiddleware<ExceptionHandlerMiddleware>();
// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{

    app.UseSwagger();
    app.UseSwaggerUI();
}
app.UseHttpsRedirection();

app.UseAuthentication();
app.UseAuthorization();
app.MapControllers();
app.Run();

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Api\Controllers\BookingController.cs
`$lang
using Microsoft.AspNetCore.Mvc;
using Cinema.Application.DTOS;
using Cinema.Application.Services.IServices;
using Microsoft.AspNetCore.Authorization;
using Cinema.Api.Extensions;

namespace Cinema.Api.Controllers;

[Authorize]
[ApiController]
[Route("/booking")]
public class BookingController : ControllerBase
{
    private readonly IBookingService _bookingService;

    public BookingController(IBookingService bookingService)
    {
        _bookingService = bookingService;
    }

    [Authorize(Roles = "User")]
    [HttpPost]
    public async Task<IActionResult> Create([FromBody] CreateBookingRequest bookingDto, CancellationToken token)
    {
        Guid userId = User.GetUserId();
        var result = await _bookingService.CreateAsync(bookingDto, userId, token);

        if (result.IsSuccess)
            return Ok(result.Value);

        return BadRequest(result.Errors.First().Message);
    }

    [Authorize(Roles = "User")]
    [HttpGet("user/{id:guid}")]
    public IAsyncEnumerable<BookingResponse> GetUserBookings(CancellationToken token)
    {
        Guid userId = User.GetUserId();

        return _bookingService.GetUserBookingsAsync(userId, token);
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Api\Controllers\FilmController.cs
`$lang
using Microsoft.AspNetCore.Mvc;
using Cinema.Application.DTOS;
using Cinema.Application.Services.IServices;
using Microsoft.AspNetCore.Authorization;

namespace Cinema.Api.Controllers;

[ApiController]
[Route("/film")]
public class FilmController : ControllerBase
{
    private readonly IFilmService _filmService;

    public FilmController(IFilmService filmService)
    {
        _filmService = filmService;
    }

    [Authorize(Roles = "Admin")]
    [HttpPost]
    public async Task<IActionResult> Create([FromBody] CreateFilmRequest filmDto, CancellationToken token)
    {
        var result = await _filmService.CreateAsync(filmDto, token);

        if (result.IsSuccess)
            return Ok(result.Value);

        return BadRequest(result.Errors.First().Message);
    }
    [Authorize(Roles = "Admin")]
    [HttpGet]
    public IAsyncEnumerable<FilmResponse> GetAll(CancellationToken token)
    {
        return _filmService.GetAllAsync(token);
    }
}


`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Api\Controllers\HallController.cs
`$lang
using Microsoft.AspNetCore.Mvc;
using Cinema.Application.Services.IServices;
using Cinema.Application.DTOS;
using Microsoft.AspNetCore.Authorization;

namespace Cinema.Api.Controllers;

[ApiController]
[Route("/hall")]
public class HallController : ControllerBase
{
    private readonly IHallService _hallService;
    private readonly ISeatService _seatService;

    public HallController(IHallService hallService, ISeatService seatService)
    {
        _hallService = hallService;
        _seatService = seatService;
    }

    [Authorize(Roles = "Admin")]
    [HttpPost]
    public async Task<IActionResult> Create([FromBody] CreateHallRequest hallDto, CancellationToken token)
    {
        var result = await _hallService.CreateAsync(hallDto, token);

        if (result.IsSuccess)
            return Ok(result.Value);

        return BadRequest(result.Errors.First().Message);
    }

    [Authorize(Roles = "Admin")]
    [HttpGet]
    public IAsyncEnumerable<HallResponse> GetAll(CancellationToken token)
    {
        return _hallService.GetAllAsync(token);
    }

    [Authorize(Roles = "Admin, User")]
    [HttpGet("{id:guid}/seats")]
    public IAsyncEnumerable<SeatResponse> GetSeats([FromRoute] Guid id, CancellationToken token)
    {
        return _seatService.GetHallSeatsAsync(id, token);
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Api\Controllers\SeatController.cs
`$lang
using Microsoft.AspNetCore.Mvc;
using Cinema.Application.Services.IServices;
using Cinema.Application.DTOS;
using Microsoft.AspNetCore.Authorization;

namespace Cinema.Api.Controlleres;

[ApiController]
[Route("/seat")]
public class SeatController : ControllerBase
{
    private readonly ISeatService _seatService;

    public SeatController(ISeatService seatService)
    {
        _seatService = seatService;
    }
}


`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Api\Controllers\SessionController.cs
`$lang
using Cinema.Application.DTOS;
using Cinema.Application.Services.IServices;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Authorization;

namespace Cinema.Api.Controllers;

[ApiController]
[Route("/session")]
public class SessionController : ControllerBase
{
    private readonly ISessionService _sessionService;
    private readonly IFilmService _filmService;
    private readonly IHallService _hallService;

    public SessionController(ISessionService sessionService, IFilmService filmService, IHallService hallService)
    {
        _sessionService = sessionService;
        _filmService = filmService;
        _hallService = hallService;
    }

    [Authorize(Roles = "Admin")]
    [HttpPost]
    public async Task<IActionResult> Create([FromBody] CreateSessionRequest sessionDto, CancellationToken token)
    {
        var result = await _sessionService.CreateAsync(sessionDto, token);

        if (result.IsFailed)
        {
            return Ok(result.Errors.First().Message);
        }

        return Ok(result.Value);

    }

    [Authorize(Roles = "User, Admin")]
    [HttpGet]
    public IAsyncEnumerable<SessionResponse> GetAll(CancellationToken token)
    {
        return _sessionService.GetAllAsync(token);
    }

    [Authorize(Roles = "Admin")]
    [HttpDelete("{id:guid}")]
    public async Task<IActionResult> DeleteAsync([FromRoute] Guid id, CancellationToken token)
    {
        var result = await _sessionService.DeleteAsync(id, token);

        if (result.IsSuccess)
            return Ok();

        return BadRequest(result.Errors.First().Message);
    }
}



`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Api\Controllers\UserContorller.cs
`$lang
using Microsoft.AspNetCore.Mvc;
using Cinema.Application.Services.IServices;
using Cinema.Application.DTOS;
using Microsoft.AspNetCore.Authorization;
using static Cinema.Api.Extensions.ClaimExtensions;
using Microsoft.AspNetCore.Authorization;
namespace Cinema.Api.Controllers;

[ApiController]
[Route("/user")]
public class UserController : ControllerBase
{
    private readonly IUserService _userService;
    private readonly IBookingService _bookingService;

    public UserController(IUserService userService, IBookingService bookingService)
    {
        _userService = userService;
        _bookingService = bookingService;
    }

    [AllowAnonymous]
    [HttpPost("login")]
    public async Task<IActionResult> Login([FromBody] LoginRequest loginDto, CancellationToken token)
    {
        var result = await _userService.LoginAsync(loginDto, token);

        if (result.IsSuccess)
            return Ok(new { accessToken = result.Value });

        return BadRequest(result.Errors.First().Message);
    }

    [AllowAnonymous]
    [HttpPost]
    public async Task<IActionResult> Create([FromBody] CreateUserRequest userDto, CancellationToken token)
    {
        var result = await _userService.CreateAsync(userDto, token);

        if (result.IsSuccess)
            return Ok(result.Value);

        return BadRequest(result.Errors.First().Message);
    }

    [Authorize]
    [HttpPut("{amount:decimal}")]
    public async Task<IActionResult> AddMoney(decimal amount, CancellationToken token)
    {
        Guid userId = User.GetUserId();

        var result = await _userService.AddMoneyAsync(amount, userId);

        if (result.IsSuccess)
            return Ok();

        return BadRequest(result.Errors.First().Message);
    }

    [Authorize(Roles = "Admin")]
    [HttpGet]
    public IAsyncEnumerable<UserResponse> GetAll(CancellationToken token)
    {
        return _userService.GetAllAsync(token);
    }

    [AllowAnonymous]
    [HttpPost("/createAdmin")]
    public async Task<IActionResult> CreateAdmin(CancellationToken token)
    {
        var result = await _userService.CreateAdminAsync(token);

        if (result.IsSuccess)
            return Ok("Admin created");

        return BadRequest(result.Errors.First().Message);
    }

    [Authorize(Roles = "User")]
    [HttpDelete]
    public async Task<IActionResult> Delete(CancellationToken token)
    {
        Guid userId = User.GetUserId();

        var result = await _userService.DeleteAsync(userId);

        if (result.IsSuccess)
            return Ok("Account has been deleted");

        return BadRequest(result.Errors.First().Message);
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Api\Extensions\CliamExtensions.cs
`$lang
using System.Security.Claims;

namespace Cinema.Api.Extensions;

public static class ClaimExtensions
{
    public static Guid GetUserId(this ClaimsPrincipal user)
    {
        var claim = user.FindFirstValue(ClaimTypes.NameIdentifier);

        Guid userId;

        if (claim is null || !Guid.TryParse(claim, out userId))
            throw new UnauthorizedAccessException("UserId claim is missing");

        return userId;
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Api\Extensions\DependencyInjectionExtensions.cs
`$lang
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.IdentityModel.Tokens;
using System.Text;

namespace Cinema.Api.Extensions;

public static class DependencyInjection
{
    public static IServiceCollection AddAuth(this IServiceCollection services, IConfiguration configuration)
    {
        services.AddAuthentication(options =>
        {
            options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
            options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
        })

        .AddJwtBearer(options =>
        {
            options.TokenValidationParameters = new TokenValidationParameters
            {
                ValidateIssuer = true,
                ValidateAudience = true,
                ValidateLifetime = true,
                ValidateIssuerSigningKey = true,

                ValidIssuer = configuration["JwtSettings:Issuer"],
                ValidAudience = configuration["JwtSettings:Audience"],

                IssuerSigningKey = new SymmetricSecurityKey(
              Encoding.UTF8.GetBytes(configuration["JwtSettings:Secret"]!))
            };
        });

        return services;
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Api\Properties\launchSettings.json
`$lang
{
  "$schema": "https://json.schemastore.org/launchsettings.json",
  "profiles": {
    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": false,
      "applicationUrl": "http://localhost:5141",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "https": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": false,
      "applicationUrl": "https://localhost:7096;http://localhost:5141",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Application.csproj
`$lang
<Project Sdk="Microsoft.NET.Sdk">

  <ItemGroup>
    <ProjectReference Include="..\Domain\Domain.csproj" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="AutoMapper" Version="16.0.0" />
    <PackageReference Include="FluentResults" Version="4.0.0" />
  </ItemGroup>

  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

</Project>

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Abstractions\IJwtTokenGenerator.cs
`$lang
using Cinema.Domain.Enums;
namespace Cinema.Application.Abstractions;

public interface IJwtTokenGenerator
{
    Task<string> GenerateToken(Guid userId, string name, string email, Role role);
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Abstractions\IPasswordHasher.cs
`$lang
namespace Cinema.Application.Abstractions;

public interface IPasswordHasher
{
    string Hash(string password);

    bool Verify(string password, string passwordHash);
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Abstractions\IUnitOfWork.cs
`$lang
namespace Cinema.Application.Abstractions;

public interface IUnitOfWork
{
    Task BeginAsync(CancellationToken token = default);

    Task CommitAsync(CancellationToken token = default);

    Task RollbackAsync(CancellationToken token = default);

    Task SaveChangesAsync(CancellationToken token = default);
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Abstractions\IRepositoies\IBaseRepository.cs
`$lang
namespace Cinema.Application.Abstractions.IRepositories;

public interface IBaseRepository<T>
{
    Task<T?> GetByIdAsync(Guid id, CancellationToken token = default);

    Task<T?> UpdateAsync(T entity, CancellationToken token = default);

    Task<bool> DeleteAsync(Guid id, CancellationToken token = default);

    IAsyncEnumerable<T> GetAllAsync(CancellationToken token = default);

    Task<T?> CreateAsync(T entity, CancellationToken token = default);
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Abstractions\IRepositoies\IBookingRepository.cs
`$lang
using Cinema.Domain.Entities;

namespace Cinema.Application.Abstractions.IRepositories;

public interface IBookingRepository : IBaseRepository<Booking>
{
    IAsyncEnumerable<Booking> GetByUserIdAsync(Guid id, CancellationToken token = default);

    Task<Booking?> GetByIdWithNavigationPropertiesAsync(Guid id, CancellationToken token = default);
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Abstractions\IRepositoies\IFilmRepository.cs
`$lang
using Cinema.Domain.Entities;

namespace Cinema.Application.Abstractions.IRepositories;

public interface IFilmRepository : IBaseRepository<Film>
{
    Task<Film?> GetByTitleAsync(string title, CancellationToken token = default);
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Abstractions\IRepositoies\IHallRepository.cs
`$lang
using Cinema.Domain.Entities;

namespace Cinema.Application.Abstractions.IRepositories;

public interface IHallRepository : IBaseRepository<Hall>;

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Abstractions\IRepositoies\ISeatRepository.cs
`$lang
using Cinema.Domain.Entities;

namespace Cinema.Application.Abstractions.IRepositories;

public interface ISeatRepository : IBaseRepository<Seat>
{
    IAsyncEnumerable<Seat> GetByHallIdAsync(Guid id, CancellationToken token);
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Abstractions\IRepositoies\ISessionRepository.cs
`$lang
using Cinema.Domain.Entities;

namespace Cinema.Application.Abstractions.IRepositories;

public interface ISessionRepository : IBaseRepository<Session>
{
    Task<Session?> GetByIdWithNavigationPropertyAsync(Guid id, CancellationToken token = default);

    IAsyncEnumerable<Session> GetByHallIdAsync(Guid id, CancellationToken token = default);
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Abstractions\IRepositoies\IUserRepository.cs
`$lang
using Cinema.Domain.Entities;

namespace Cinema.Application.Abstractions.IRepositories;

public interface IUserRepository : IBaseRepository<User>
{
    Task<User?> GetByEmailAsync(string name, CancellationToken token = default);

    Task<User?> GetByIdWithNavigationPropertyAsync(Guid id, CancellationToken tokne = default);
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\DTOS\BookingResponse.cs
`$lang
namespace Cinema.Application.DTOS;

public record BookingResponse
{
    public Guid Id { get; init; }
    public Guid SessionId { get; init; }
    public string FilmTitle { get; init; } = string.Empty;
    public decimal Cost { get; init; }
    public List<RawNum> Positions { get; init; } = new();

    public BookingResponse() { }

    public BookingResponse(Guid id, Guid sessionId, string filmTitle, decimal cost, List<RawNum> positions)
    {
        Id = id;
        SessionId = sessionId;
        FilmTitle = filmTitle;
        Cost = cost;
        Positions = positions;
    }
}


`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\DTOS\CreateBookingsRequest.cs
`$lang
namespace Cinema.Application.DTOS;

public record CreateBookingRequest
{
    public Guid SessionId { get; init; }
    public List<Guid> Seats { get; init; } = new();

    public CreateBookingRequest() { }

    public CreateBookingRequest(Guid sessionId, List<Guid> seats)
    {
        SessionId = sessionId;
        Seats = seats;
    }
}


`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\DTOS\CreateFilmRequest.cs
`$lang
namespace Cinema.Application.DTOS;

public record CreateFilmRequest
{
    public string Title { get; init; } = string.Empty;
    public decimal Price { get; init; }
    public int Duration { get; init; }

    public CreateFilmRequest(string title, decimal price, int duration)
    {
        Title = title;
        Price = price;
        Duration = duration;
    }

    public CreateFilmRequest() { }
}


`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\DTOS\CreateHallRequest.cs
`$lang
namespace Cinema.Application.DTOS;

public record CreateHallRequest
{
    public string Title { get; init; } = string.Empty;
    public int Raw { get; init; }
    public int Column { get; init; }

    public CreateHallRequest(string title, int raw, int column)
    {
        Title = title;
        Raw = raw;
        Column = column;
    }

    public CreateHallRequest() { }
}


`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\DTOS\CreateSessionRequest.cs
`$lang
namespace Cinema.Application.DTOS;

public record CreateSessionRequest
{
    public Guid HallId { get; init; }
    public Guid FilmId { get; init; }
    public DateTime Start { get; init; }

    public CreateSessionRequest(Guid hallId, Guid filmId, DateTime start)
    {
        HallId = hallId;
        FilmId = filmId;
        Start = start;
    }

    public CreateSessionRequest() { }
}




`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\DTOS\CreateUserRequest.cs
`$lang
using Cinema.Domain.Enums;

namespace Cinema.Application.DTOS;

public record CreateUserRequest
{
    public string Name { get; init; } = string.Empty;
    public string Email { get; init; } = string.Empty;
    public string Password { get; init; } = string.Empty;
    public Role Role { get; init; }

    public CreateUserRequest(string name, string email, string password, Role role)
    {
        Name = name;
        Email = email;
        Password = password;
        Role = role;
    }

    public CreateUserRequest() { }
}


`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\DTOS\FilmResponse.cs
`$lang
namespace Cinema.Application.DTOS;


public record FilmResponse
{
    public Guid Id { get; init; }
    public string Title { get; init; } = string.Empty;
    public decimal Price { get; init; }
    public int Duration { get; init; }

    public FilmResponse(Guid id, string title, decimal price, int duration)
    {
        Id = id;
        Title = title;
        Price = price;
        Duration = duration;
    }

    public FilmResponse() { }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\DTOS\HallResponse.cs
`$lang
namespace Cinema.Application.DTOS;

public record HallResponse
{
    public Guid Id { get; init; }
    public string Title { get; init; } = string.Empty;

    public HallResponse(Guid id, string title)
    {
        Id = id;
        Title = title;
    }

    public HallResponse() { }
}


`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\DTOS\LoginRequest.cs
`$lang
namespace Cinema.Application.DTOS;

public record LoginRequest(string Email, string Password);

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\DTOS\RawNumDto.cs
`$lang
namespace Cinema.Application.DTOS;

public record RawNum
{
    public int Raw { get; init; }
    public int Num { get; init; }

    public RawNum(int raw, int num)
    {
        Raw = raw;
        Num = num;
    }

    public RawNum() { }
}


`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\DTOS\SeatResponse.cs
`$lang
namespace Cinema.Application.DTOS;

public record SeatResponse
{
    public Guid Id { get; init; }
    public bool IsOccupied { get; init; }
    public int Raw { get; init; }
    public int Num { get; init; }

    public SeatResponse(Guid id, bool isOccupied, int raw, int num)
    {
        Id = id;
        IsOccupied = isOccupied;
        Raw = raw;
        Num = num;
    }

    public SeatResponse() { }

}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\DTOS\SessionResponse.cs
`$lang
namespace Cinema.Application.DTOS;

public record SessionResponse
{
    public Guid Id { get; init; }
    public Guid HallId { get; init; }
    public DateTime Start { get; init; }
    public DateTime End { get; init; }
    public string FilmTitle { get; init; } = string.Empty;

    public SessionResponse(Guid id, Guid hallId, DateTime start, DateTime end, string filmTitle)
    {
        Id = id;
        HallId = hallId;
        Start = start;
        End = end;
        FilmTitle = filmTitle;
    }

    public SessionResponse() { }
}


`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\DTOS\UserResponse.cs
`$lang
namespace Cinema.Application.DTOS;

public record UserResponse
{
    public Guid Id { get; init; }
    public string Name { get; init; } = string.Empty;
    public string Email { get; init; } = string.Empty;
    public decimal WalletBalance { get; init; }

    public UserResponse(Guid id, string name, string email, decimal walletBalance)
    {
        Id = id;
        Name = name;
        Email = email;
        WalletBalance = walletBalance;
    }

    public UserResponse() { }
}


`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Exceptions\ApplicationException.cs
`$lang
namespace Cinema.Application.Exceptions;

public class ApplicationException : Exception
{
    public string Title { get; }

    public ApplicationException(string title, string message)
      : base(message)
    {
        Title = title;
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Exceptions\ApplicationPersistenceException.cs
`$lang
namespace Cinema.Application.Exceptions;

public class ApplicationPersistenceException : ApplicationException
{
    public ApplicationPersistenceException(string message)
      : base("Persistence Error", message)
    {

    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Helpers\CinemaSettings.cs
`$lang
using Cinema.Domain.Abstractions;

namespace Cinema.Application.Helpers;

public class CinemaSettings : ICinemaSettings
{
    public int OpeningHour { get; set; }
    public int ClosingHour { get; set; }
    public int MinMinuteAddSession { get; set; }
    public int MaxDaysAddSession { get; set; }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\MappingProfiles\BookingProfile.cs
`$lang
using Cinema.Domain.Entities;
using Cinema.Application.DTOS;
using AutoMapper;

namespace Cinema.Application.MappingProfiles;

public class BookingProfile : Profile
{
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\MappingProfiles\FilmProfile.cs
`$lang
using Cinema.Domain.Entities;
using Cinema.Application.DTOS;
using AutoMapper;

namespace Cinema.Application.MappingProfiles;

public class FilmProfile : Profile
{
    public FilmProfile()
    {
        CreateMap<CreateFilmRequest, Film>()
          .ConstructUsing(src =>
            new Film(
              src.Title,
              src.Price,
              src.Duration
            ));

        CreateMap<Film, FilmResponse>();
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\MappingProfiles\HallProfile.cs
`$lang
using Cinema.Domain.Entities;
using Cinema.Application.DTOS;
using AutoMapper;

public class HallProfile : Profile
{
    public HallProfile()
    {
        CreateMap<Hall, HallResponse>();
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\MappingProfiles\SeatProfile.cs
`$lang
using Cinema.Domain.Entities;
using Cinema.Application.DTOS;
using AutoMapper;

namespace Cinema.Application.MappingProfiles;

public class SeatProfile : Profile
{
    public SeatProfile()
    {
        CreateMap<Seat, SeatResponse>()
          .ForMember(dest => dest.Num, opt => opt.MapFrom(src => src.Position.Num))
          .ForMember(dest => dest.Raw, opt => opt.MapFrom(src => src.Position.Raw));
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\MappingProfiles\SessionProfile.cs
`$lang
using Cinema.Domain.Entities;
using Cinema.Application.DTOS;
using AutoMapper;

namespace Cinema.Application.MappingProfiles;

public class SessionProfile : Profile
{
    public SessionProfile()
    {
        CreateMap<Session, SessionResponse>()
          .ForMember(dest => dest.Start, opt => opt.MapFrom(src => src.Duration.Start))
          .ForMember(dest => dest.End, opt => opt.MapFrom(src => src.Duration.End))
          .ForMember(dest => dest.FilmTitle, opt => opt.MapFrom(src => src.Film!.Title
                      ));
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\MappingProfiles\UserProfile.cs
`$lang
using AutoMapper;
using Cinema.Domain.Entities;
using Cinema.Application.DTOS;
using Cinema.Domain.ValueObjects;

namespace Cinema.Application.MappingProfiles;

public class UserProfile : Profile
{
    public UserProfile()
    {
        CreateMap<CreateUserRequest, User>()
            .ConstructUsing(src =>
                new User(
                    src.Name,
                    Email.Create(src.Email),
                    src.Password,
                    src.Role
                    ));

        CreateMap<User, UserResponse>()
            .ForMember(dest => dest.Email, opt => opt.MapFrom(src => src.Email.Value));
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Services\BookingService.cs
`$lang
using Cinema.Application.DTOS;
using Cinema.Domain.Entities;
using Cinema.Application.Abstractions.IRepositories;
using System.Runtime.CompilerServices;
using AutoMapper;
using Cinema.Application.Abstractions;
using Cinema.Application.Services.IServices;
using Cinema.Application.Exceptions;
using FluentResults;

namespace Cinema.Application.Services;

public class BookingService : IBookingService
{
    private readonly IBookingRepository _bookingRepository;
    private readonly ISessionRepository _sessionRepository;
    private readonly IUserRepository _userRepository;
    private readonly ISeatRepository _seatRepository;
    private readonly IMapper _mapper;
    private readonly IUnitOfWork _uow;


    public BookingService(IBookingRepository bookingRepository, IMapper mapper, ISessionRepository sessionRepository, IUserRepository userRepository, IUnitOfWork uow, ISeatRepository seatRepository)
    {
        _bookingRepository = bookingRepository;
        _mapper = mapper;
        _sessionRepository = sessionRepository;
        _userRepository = userRepository;
        _uow = uow;
        _seatRepository = seatRepository;
    }

    public async Task<Result<BookingResponse>> CreateAsync(CreateBookingRequest bookingDto, Guid userId, CancellationToken token)
    {
        var session = await _sessionRepository.GetByIdWithNavigationPropertyAsync(bookingDto.SessionId, token);
        var user = await _userRepository.GetByIdAsync(userId, token);
        if (session is null || user is null)
            return session is null ? Result.Fail("Session not found") : Result.Fail("User not found");

        decimal bookingCost = session.Film!.Price * bookingDto.Seats.Count();
        if (user.Wallet.Balance < bookingCost) return Result.Fail("Not enough money");

        Booking booking = new(userId, bookingDto.SessionId, bookingCost, bookingDto.Seats);

        await _uow.BeginAsync(token);

        try
        {
            user.Wallet.Deduct(booking.Cost);

            var r1 = await _userRepository.UpdateAsync(user);
            var r2 = await _bookingRepository.CreateAsync(booking, token);

            if (r2 is null || r1 is null) throw new Exception();

            List<RawNum> positions = new();

            foreach (var seatId in booking.Seats)
            {
                var seat = await _seatRepository.GetByIdAsync(seatId, token);

                if (seat is null || seat.IsOccupied is true)
                    throw new Exception();

                seat!.ChangeStatus(true);
                await _seatRepository.UpdateAsync(seat);
                positions.Add(new RawNum(seat.Position.Raw, seat.Position.Num));
            }

            await _uow.CommitAsync();

            return new BookingResponse(booking.Id, session.Id, session.Film.Title, booking.Cost, positions);
        }
        catch
        {
            await _uow.RollbackAsync(token);
            return Result.Fail("Transaction Failed");
        }
    }

    public async IAsyncEnumerable<BookingResponse> GetUserBookingsAsync(Guid id, [EnumeratorCancellation] CancellationToken token)
    {
        await foreach (var booking in _bookingRepository.GetByUserIdAsync(id, token))
        {
            yield return _mapper.Map<BookingResponse>(booking);
        }
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Services\FilmService.cs
`$lang
using Cinema.Application.DTOS;
using Cinema.Application.Abstractions.IRepositories;
using Cinema.Application.Services.IServices;
using Cinema.Domain.Entities;
using AutoMapper;
using System.Runtime.CompilerServices;
using Cinema.Application.Exceptions;
using FluentResults;

namespace Cinema.Application.Services;

public class FilmService : IFilmService
{
    private readonly IFilmRepository _filmRepository;
    private readonly IMapper _mapper;

    public FilmService(IFilmRepository filmRepository, IMapper mapper)
    {
        _filmRepository = filmRepository;
        _mapper = mapper;
    }

    public async IAsyncEnumerable<FilmResponse> GetAllAsync([EnumeratorCancellation] CancellationToken token)
    {
        await foreach (var film in _filmRepository.GetAllAsync(token))
        {
            yield return _mapper.Map<FilmResponse>(film);
        }
    }

    public async Task<Result<FilmResponse>> CreateAsync(CreateFilmRequest filmDto, CancellationToken token)
    {
        var film = _mapper.Map<Film>(filmDto);

        try
        {
            await _filmRepository.CreateAsync(film, token);

            return Result.Ok(_mapper.Map<FilmResponse>(film));
        }
        catch (ApplicationPersistenceException ex)
        {
            return Result.Fail(ex.Message);
        }
    }

    public async Task<Result> DeleteAsync(Guid id, CancellationToken token)
    {
        try
        {
            bool result = await _filmRepository.DeleteAsync(id, token);

            return result ? Result.Ok() : Result.Fail("Film not found");
        }
        catch (ApplicationPersistenceException ex)
        {
            return Result.Fail(ex.Message);
        }
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Services\HallService.cs
`$lang
using Cinema.Application.DTOS;
using Cinema.Application.Abstractions.IRepositories;
using Cinema.Application.Services.IServices;
using Cinema.Domain.Entities;
using AutoMapper;
using System.Runtime.CompilerServices;
using FluentResults;
using Cinema.Application.Exceptions;

namespace Cinema.Application.Services;

public class HallService : IHallService
{
    private readonly IHallRepository _hallRepository;
    private readonly IMapper _mapper;

    public HallService(IHallRepository hallRepository, IMapper mapper)
    {
        _hallRepository = hallRepository;
        _mapper = mapper;
    }

    public async IAsyncEnumerable<HallResponse> GetAllAsync([EnumeratorCancellation] CancellationToken token)
    {
        await foreach (var hall in _hallRepository.GetAllAsync(token))
        {
            yield return _mapper.Map<HallResponse>(hall);
        }
    }

    public async Task<Result<HallResponse>> CreateAsync(CreateHallRequest hallDto, CancellationToken token)
    {
        Hall hall = new(hallDto.Title, hallDto.Raw, hallDto.Column);

        try
        {
            await _hallRepository.CreateAsync(hall, token);

            return Result.Ok(_mapper.Map<HallResponse>(hall));
        }
        catch (ApplicationPersistenceException ex)
        {
            return Result.Fail(ex.Message);
        }
    }

    public async Task<Result> DeleteAsync(Guid id, CancellationToken token)
    {
        try
        {
            bool result = await _hallRepository.DeleteAsync(id, token);

            return result ? Result.Ok() : Result.Fail("Hall not found");
        }
        catch (ApplicationPersistenceException ex)
        {
            return Result.Fail(ex.Message);
        }
    }



}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Services\SeatService.cs
`$lang
using Cinema.Domain.Entities;
using Cinema.Application.DTOS;
using Cinema.Application.Services.IServices;
using AutoMapper;
using Cinema.Application.Abstractions.IRepositories;
using System.Runtime.CompilerServices;

namespace Cinema.Application.Services;

public class SeatService : ISeatService
{
    private readonly ISeatRepository _seatRepository;
    private readonly IMapper _mapper;

    public SeatService(ISeatRepository seatRepository, IMapper mapper)
    {
        _seatRepository = seatRepository;
        _mapper = mapper;
    }

    public async IAsyncEnumerable<SeatResponse> GetHallSeatsAsync(Guid id, [EnumeratorCancellation] CancellationToken token)
    {
        await foreach (Seat seat in _seatRepository.GetByHallIdAsync(id, token))
        {
            yield return _mapper.Map<SeatResponse>(seat);
        }
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Services\SessionService.cs
`$lang
using Cinema.Domain.Entities;
using Cinema.Domain.ValueObjects;
using Cinema.Application.DTOS;
using Cinema.Application.Abstractions.IRepositories;
using Cinema.Application.Services.IServices;
using AutoMapper;
using Cinema.Domain.Policies;
using System.Runtime.CompilerServices;
using FluentResults;
using Cinema.Application.Exceptions;
using Cinema.Domain.Exceptions;

namespace Cinema.Application.Services;

public class SessionService : ISessionService
{
    private readonly ISessionRepository _sessionRepository;
    private readonly IFilmRepository _filmRepository;
    private readonly IMapper _mapper;
    private readonly SessionPolicy _sessionPolicy;
    private readonly IHallRepository _hallRepository;

    public SessionService(ISessionRepository sessionRepository, IMapper mapper, IFilmRepository filmRepository, SessionPolicy sessionPolicy, IHallRepository hallRepository)
    {
        _sessionRepository = sessionRepository;
        _mapper = mapper;
        _filmRepository = filmRepository;
        _sessionPolicy = sessionPolicy;
        _hallRepository = hallRepository;
    }

    public async Task<Result<SessionResponse>> CreateAsync(CreateSessionRequest sessionDto, CancellationToken token)
    {
        var film = await _filmRepository.GetByIdAsync(sessionDto.FilmId);

        if (film is null) return Result.Fail("Film not Found");

        Session session = new(sessionDto.HallId, sessionDto.FilmId, Duration.Create(sessionDto.Start, film.Duration));
        session.AttachFilm(film);

        var timeSlots = new List<SessionTimeSlot>();

        await foreach (var ses in _sessionRepository.GetByHallIdAsync(session.HallId, token))
        {
            timeSlots.Add(new SessionTimeSlot(ses.Duration.Start, ses.Duration.End));
        }

        try
        {
            _sessionPolicy.Check(session.Duration.Start, session.Duration.End, timeSlots.AsReadOnly());
        }
        catch (BusinessRuleException ex)
        {
            return Result.Fail(ex.Message);
        }

        try
        {
            await _sessionRepository.CreateAsync(session, token);

            return Result.Ok(_mapper.Map<SessionResponse>(session));
        }
        catch (ApplicationPersistenceException ex)
        {
            return Result.Fail(ex.Message);
        }
    }

    public async IAsyncEnumerable<SessionResponse> GetAllAsync([EnumeratorCancellation] CancellationToken token)
    {
        await foreach (var session in _sessionRepository.GetAllAsync(token))
        {
            yield return _mapper.Map<SessionResponse>(session);
        }
    }

    public async Task<Result> DeleteAsync(Guid id, CancellationToken token)
    {
        try
        {
            var result = await _sessionRepository.DeleteAsync(id);

            return result == true ? Result.Ok() : Result.Fail("Session not found");
        }
        catch (ApplicationPersistenceException ex)
        {
            return Result.Fail(ex.Message);
        }
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Services\UserServices.cs
`$lang
using Cinema.Application.DTOS;
using Cinema.Domain.Entities;
using Cinema.Application.Abstractions.IRepositories;
using Cinema.Application.Abstractions;
using Cinema.Application.Services.IServices;
using AutoMapper;
using System.Runtime.CompilerServices;
using FluentResults;
using Cinema.Application.Exceptions;
using Cinema.Domain.Enums;
using Cinema.Domain.ValueObjects;

namespace Cinema.Application.Services;

public class UserService : IUserService
{
    private readonly IUserRepository _userRepository;
    private readonly IMapper _mapper;
    private readonly IPasswordHasher _hasher;
    private readonly IJwtTokenGenerator _jwt;

    public UserService(IUserRepository userRepository, IMapper mapper, IPasswordHasher hasher, IJwtTokenGenerator jwt)
    {
        _userRepository = userRepository;
        _mapper = mapper;
        _hasher = hasher;
        _jwt = jwt;
    }

    public async Task<Result> CreateAdminAsync(CancellationToken token)
    {
        User admin = new("admin", Email.Create("admin@gmail.com"), _hasher.Hash("admin"), Role.Admin);

        try
        {
            var result = await _userRepository.CreateAsync(admin);

            return result is not null ? Result.Ok() : Result.Fail("Admin already exists");
        }
        catch (ApplicationPersistenceException ex)
        {
            return Result.Fail(ex.Message);
        }
    }
    public async IAsyncEnumerable<UserResponse> GetAllAsync([EnumeratorCancellation] CancellationToken token)
    {
        await foreach (var user in _userRepository.GetAllAsync(token))
        {
            yield return _mapper.Map<UserResponse>(user);
        }
    }

    public async Task<Result<string>> LoginAsync(LoginRequest loginDto, CancellationToken token)
    {
        var user = await _userRepository.GetByEmailAsync(loginDto.Email);

        if (user is null) return Result.Fail("User not found");

        if (_hasher.Verify(loginDto.Password, user.PasswordHash))
        {
            return Result.Ok(await _jwt.GenerateToken(user.Id, user.Name, user.Email.Value, user.Role));
        }
        else
        {
            return Result.Fail("UnCorrect password");
        }
    }
    public async Task<Result<UserResponse>> CreateAsync(CreateUserRequest userDto, CancellationToken token)
    {
        var user = _mapper.Map<User>(userDto with { Password = _hasher.Hash(userDto.Password) });

        if (await _userRepository.GetByEmailAsync(userDto.Email) is not null) return Result.Fail("User with this email already exists");
        try
        {
            await _userRepository.CreateAsync(user, token);

            return _mapper.Map<UserResponse>(user);
        }
        catch (ApplicationPersistenceException ex)
        {
            return Result.Fail(ex.Message);
        }
    }

    public async Task<Result> DeleteAsync(Guid id, CancellationToken token)
    {
        try
        {
            bool result = await _userRepository.DeleteAsync(id, token);

            return result == true ? Result.Ok() : Result.Fail("User not found");
        }
        catch (ApplicationPersistenceException ex)
        {
            return Result.Fail(ex.Message);
        }
    }

    public async Task<Result<UserResponse>> AddMoneyAsync(decimal amount, Guid id, CancellationToken token)
    {
        var user = await _userRepository.GetByIdAsync(id, token);

        if (user is null) return Result.Fail("User not found");

        user.Wallet.Add(amount);
        try
        {
            await _userRepository.UpdateAsync(user, token);

            return Result.Ok(_mapper.Map<UserResponse>(user));
        }
        catch (ApplicationPersistenceException ex)
        {
            return Result.Fail(ex.Message);
        }
    }

    public async Task<Result<UserResponse>> GetByIdAsync(Guid id, CancellationToken token)
    {
        var user = await _userRepository.GetByIdAsync(id, token);

        return user is null ? Result.Fail("User not found") : Result.Ok(_mapper.Map<UserResponse>(user));
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Services\IServices\IBookingService.cs
`$lang
using Cinema.Application.DTOS;
using FluentResults;

namespace Cinema.Application.Services.IServices;

public interface IBookingService
{
    Task<Result<BookingResponse>> CreateAsync(CreateBookingRequest bookingDto, Guid userId, CancellationToken token = default);

    IAsyncEnumerable<BookingResponse> GetUserBookingsAsync(Guid id, CancellationToken token);
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Services\IServices\IFilmService.cs
`$lang
using Cinema.Application.DTOS;
using FluentResults;

namespace Cinema.Application.Services.IServices;

public interface IFilmService
{
    Task<Result<FilmResponse>> CreateAsync(CreateFilmRequest filmDto, CancellationToken token = default);

    Task<Result> DeleteAsync(Guid id, CancellationToken token = default);

    IAsyncEnumerable<FilmResponse> GetAllAsync(CancellationToken token);
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Services\IServices\IHallService.cs
`$lang
using Cinema.Application.DTOS;
using FluentResults;

namespace Cinema.Application.Services.IServices;

public interface IHallService
{
    Task<Result<HallResponse>> CreateAsync(CreateHallRequest hallDto, CancellationToken token = default);

    Task<Result> DeleteAsync(Guid id, CancellationToken token = default);

    IAsyncEnumerable<HallResponse> GetAllAsync(CancellationToken token);
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Services\IServices\ISeatService.cs
`$lang
using Cinema.Domain.Entities;
using Cinema.Application.DTOS;

namespace Cinema.Application.Services.IServices;

public interface ISeatService
{
    IAsyncEnumerable<SeatResponse> GetHallSeatsAsync(Guid id, CancellationToken token = default);
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Services\IServices\ISessionService.cs
`$lang
using Cinema.Application.DTOS;
using FluentResults;

namespace Cinema.Application.Services.IServices;

public interface ISessionService
{
    Task<Result<SessionResponse>> CreateAsync(CreateSessionRequest sessionDto, CancellationToken token = default);

    IAsyncEnumerable<SessionResponse> GetAllAsync(CancellationToken token = default);

    Task<Result> DeleteAsync(Guid id, CancellationToken token = default);
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Application\Services\IServices\IUserService.cs
`$lang
using Cinema.Application.DTOS;
using FluentResults;

namespace Cinema.Application.Services.IServices;

public interface IUserService
{
    Task<Result<UserResponse>> CreateAsync(CreateUserRequest userDto, CancellationToken token = default);

    Task<Result> DeleteAsync(Guid id, CancellationToken token = default);

    IAsyncEnumerable<UserResponse> GetAllAsync(CancellationToken token);

    Task<Result<UserResponse>> AddMoneyAsync(decimal amount, Guid id, CancellationToken token = default);

    Task<Result<string>> LoginAsync(LoginRequest loginDto, CancellationToken token = default);

    Task<Result> CreateAdminAsync(CancellationToken token = default);
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Domain\Domain.csproj
`$lang
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

</Project>

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Domain\Abstractions\ICinemaSettings.cs
`$lang
namespace Cinema.Domain.Abstractions;

public interface ICinemaSettings
{
    int OpeningHour { get; set; }
    int ClosingHour { get; set; }
    int MinMinuteAddSession { get; set; }
    int MaxDaysAddSession { get; set; }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Domain\Abstractions\IClock.cs
`$lang
namespace Cinema.Domain.Abstractions;

public interface IClock
{
    DateTime Now { get; }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Domain\Entities\Booking.cs
`$lang
using Cinema.Domain.Exceptions;

namespace Cinema.Domain.Entities;

public class Booking
{
    public Guid Id { get; private set; }

    public Guid UserId { get; private set; }

    public User? User { get; private set; }

    public Guid SessionId { get; private set; }

    public Session? Session { get; private set; }

    public decimal Cost { get; private set; } = 0;

    public List<Guid> Seats { get; private set; } = new();

    public Booking
    (
        Guid userId,
        Guid sessionId,
        decimal cost,
        List<Guid> seats
    )
    {
        if (cost < 0)
            throw new DomainArgumentException("Cost cannot be negative");

        Id = Guid.NewGuid();
        UserId = userId;
        SessionId = sessionId;
        Cost = cost;
        Seats = seats;
    }

    public Booking
    (
        Guid id,
        Guid userId,
        User? user,
        Guid sessionId,
        Session? session,
        decimal cost,
        List<Guid> seats
    )
    {
        Id = id;
        UserId = userId;
        User = user;
        SessionId = sessionId;
        Session = session;
        Cost = cost;
        Seats = seats;
    }

    public void AttachUser(User? user)
    {
        if (user is null)
            throw new DomainArgumentException("Cannot attach null User");

        User = user;
    }

    public void AttachSession(Session? session)
    {
        if (session is null)
            throw new DomainArgumentException("Cannot attach null session");

        Session = session;
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Domain\Entities\Film.cs
`$lang
using Cinema.Domain.Exceptions;

namespace Cinema.Domain.Entities;

public class Film
{
    public Guid Id { get; private set; }

    public string Title { get; private set; } = string.Empty;

    public decimal Price { get; private set; }

    public int Duration { get; private set; }

    public Film(string title, decimal price, int duration)
    {
        if (string.IsNullOrWhiteSpace(title))
            throw new DomainArgumentException("Title cannot be null or empty");

        if (price < 0)
            throw new DomainArgumentException("Price cannot be negative");

        if (duration < 0)
            throw new DomainArgumentException("Duration cannot be negative");
        Id = Guid.NewGuid();
        Title = title;
        Price = price;
        Duration = duration;
    }

    public Film(Guid id, string title, decimal price, int duration)
    {
        Id = id;
        Title = title;
        Price = price;
        Duration = duration;
    }

    public void ChangeTitle(string newTitle)
    {
        if (string.IsNullOrWhiteSpace(newTitle))
            throw new DomainArgumentException("Title cannot be null or empty.");

        Title = newTitle;
    }

    public void ChangePrice(decimal newPrice)
    {
        if (Price < 0)
            throw new DomainArgumentException("Price cannot be negative.");

        Price = newPrice;
    }

    public void ChangeDuration(int newDuration)
    {
        if (newDuration < 0)
            throw new DomainArgumentException("Duratin cannot be negative");

        Duration = newDuration;
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Domain\Entities\Hall.cs
`$lang
using Cinema.Domain.ValueObjects;
using Cinema.Domain.Exceptions;

namespace Cinema.Domain.Entities;

public class Hall
{
    public Guid Id { get; private set; }

    public string Title { get; private set; } = string.Empty;

    public IReadOnlyList<Seat> Seats { get; }

    public Hall(string title, int raws, int columns)
    {
        if (raws < 0 || columns < 0)
            throw new BusinessRuleException("Raws or Colument cannot be negative.");

        if (string.IsNullOrWhiteSpace(title))
            throw new DomainArgumentException("Title cannot be null or empty");
        var seats = new List<Seat>();

        for (int r = 1; r <= raws; r++)
        {
            for (int c = 1; c <= columns; c++)
            {
                seats.Add(new Seat(Id, Position.Create(r, c)));
            }
        }

        Id = Guid.NewGuid();
        Title = title;
        Seats = seats;
    }

    public Hall(Guid id, string title, List<Seat> seats)
    {
        Id = id;
        Title = title;
        Seats = seats;
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Domain\Entities\Seat.cs
`$lang
using Cinema.Domain.ValueObjects;
using Cinema.Domain.Exceptions;

namespace Cinema.Domain.Entities;

public class Seat
{
    public Guid Id { get; private set; }

    public Guid HallId { get; private set; }

    public bool IsOccupied { get; private set; }

    public Position Position { get; private set; }

    internal Seat(Guid hallId, Position position)
    {
        Id = Guid.NewGuid();
        HallId = hallId;
        IsOccupied = false;
        Position = position ?? throw new DomainArgumentException("Position cannot be null");
    }

    public Seat(Guid id, Guid hallId, bool isOccupied, Position position)
    {
        Id = id;
        HallId = hallId;
        IsOccupied = isOccupied;
        Position = position;
    }

    public void ChangeStatus(bool newStatus)
    {
        IsOccupied = newStatus;
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Domain\Entities\Session.cs
`$lang
using Cinema.Domain.ValueObjects;
using Cinema.Domain.Exceptions;

namespace Cinema.Domain.Entities;

public class Session
{
    public Guid Id { get; private set; }

    public Guid HallId { get; private set; }

    public Hall? Hall { get; private set; }

    public Guid FilmId { get; private set; }

    public Film? Film { get; private set; }

    public Duration Duration { get; private set; }

    public Session
    (
        Guid hallId,
        Guid filmId,
        Duration duration
    )
    {
        Id = Guid.NewGuid();
        HallId = hallId;
        FilmId = filmId;
        Duration = duration ?? throw new DomainArgumentException("Duration cannot be null");
    }

    public Session
    (
        Guid id,
        Guid hallId,
        Hall? hall,
        Guid filmId,
        Film? film,
        Duration duration
    )
    {
        Id = id;
        HallId = hallId;
        Hall = hall;
        FilmId = filmId;
        Film = film;
        Duration = duration;
    }

    public void AttachHall(Hall? hall)
    {
        if (hall is null) throw new DomainArgumentException("Cannot attach null Hall");

        Hall = hall;
    }

    public void AttachFilm(Film? film)
    {
        if (film is null) throw new DomainArgumentException("Cannot attach null Film");

        Film = film;
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Domain\Entities\User.cs
`$lang
using Cinema.Domain.ValueObjects;
using Cinema.Domain.Enums;
using Cinema.Domain.Exceptions;

namespace Cinema.Domain.Entities;

public class User
{
    public Guid Id { get; private set; }

    public string Name { get; private set; } = string.Empty;

    public Email Email { get; private set; }

    public string PasswordHash { get; private set; } = string.Empty;

    public Role Role { get; }

    public Wallet Wallet { get; private set; }

    public List<Booking> Bookings { get; private set; } = new();

    public User
    (
        string name,
        Email email,
        string passwordHash,
        Role role
    )
    {
        if (string.IsNullOrWhiteSpace(name))
            throw new DomainArgumentException("Name cannot be null or empty.");

        if (string.IsNullOrWhiteSpace(passwordHash))
            throw new DomainArgumentException("Password cannot be null or empty");

        Id = Guid.NewGuid();
        Name = name;
        Email = email ?? throw new DomainArgumentException("Email cannot be null or empty.");
        PasswordHash = passwordHash;
        Role = role;
        Wallet = Wallet.Create(0);
    }

    public User
    (
        Guid id,
        string name,
        Email email,
        string passwordHash,
        Role role,
        Wallet wallet,
        List<Booking> bookings)
    {
        Id = id;
        Name = name;
        Email = email;
        PasswordHash = passwordHash;
        Role = role;
        Wallet = wallet;
        Bookings = bookings;
    }

    public void ChangeName(string newName)
    {
        if (string.IsNullOrWhiteSpace(newName))
            throw new DomainArgumentException("Name can't be null or empty.");

        Name = newName;
    }

    public void ChangeEmail(Email email)
    {
        Email = email ?? throw new DomainArgumentException("Email cannot be null.");
    }

    public void ChangePasswordHash(string newPasswordHash)
    {
        if (string.IsNullOrWhiteSpace(newPasswordHash))
            throw new DomainArgumentException("Password can't be null or empty.");

        PasswordHash = newPasswordHash;
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Domain\Enums\Role.cs
`$lang
namespace Cinema.Domain.Enums;

public enum Role
{
    Admin,
    User
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Domain\Enums\Status.cs
`$lang
namespace Cinema.Domain.Enums;

public enum Status
{
    Paid,
    Unpaid,
    Cancelled,
    Refunded
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Domain\Excepions\BusinessRuleException.cs
`$lang
namespace Cinema.Domain.Exceptions;

public class BusinessRuleException : DomainException
{
    public BusinessRuleException(string message)
      : base("Business Rule Violation", message)
    { }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Domain\Excepions\DomainArgumentException.cs
`$lang
namespace Cinema.Domain.Exceptions;

public class DomainArgumentException : DomainException
{
    public DomainArgumentException(string message)
      : base("Invalid argument", message)
    { }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Domain\Excepions\DomainException.cs
`$lang
namespace Cinema.Domain.Exceptions;

public abstract class DomainException : Exception
{
    public string Title { get; }

    protected DomainException(string title, string message) : base(message)
    {
        Title = title;
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Domain\Policies\SessionPolicy.cs
`$lang
using Cinema.Domain.Abstractions;
using Cinema.Domain.Exceptions;

namespace Cinema.Domain.Policies;

public class SessionPolicy
{
    private readonly IClock _clock;
    private readonly ICinemaSettings _settings;

    public SessionPolicy(IClock clock, ICinemaSettings settings)
    {
        _clock = clock;
        _settings = settings;
        _settings.OpeningHour = 9;
        _settings.ClosingHour = 23;
        _settings.MinMinuteAddSession = 60;
        _settings.MaxDaysAddSession = 10;
    }

    public void Check(DateTime start, DateTime end, IReadOnlyCollection<SessionTimeSlot> existingSessions)
    {
        DateTime now = _clock.Now;

        DateTime lastAllowedDay = now.AddDays(_settings.MaxDaysAddSession);

        if (start < now.AddMinutes(_settings.MinMinuteAddSession))
            throw new BusinessRuleException($"{_clock.Now} Session must add not less than {_settings.MinMinuteAddSession}");

        if (start > lastAllowedDay)
            throw new BusinessRuleException($"Session could add before {_settings.MaxDaysAddSession} days!");

        if (!(start.Hour * 60 + start.Minute >= _settings.OpeningHour * 60 && end.Hour * 60 + end.Minute <= _settings.ClosingHour * 60 && end.Day == start.Day))
            throw new BusinessRuleException($"Cinema is closed. Works: {_settings.OpeningHour} to {_settings.ClosingHour})");

        foreach (var timeSlot in existingSessions)
        {
            if (Overlaps(timeSlot, TimeSpan.FromMinutes(10))) throw new BusinessRuleException($"Diffrence between session must be more than 10 minutes");
        }

        bool Overlaps(SessionTimeSlot other, TimeSpan minGap)
        {
            bool intersects = start < other.end && end > other.start;

            if (intersects) return true;

            bool tooClose = start < other.end + minGap && end > other.start - minGap;

            return tooClose;
        }
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Domain\Policies\SessionTimeSlot.cs
`$lang
namespace Cinema.Domain.Policies;

public record SessionTimeSlot(DateTime start, DateTime end);

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Domain\ValueObjects\Duration.cs
`$lang
using Cinema.Domain.Exceptions;

namespace Cinema.Domain.ValueObjects;

public sealed class Duration
{
    public DateTime Start { get; }
    public DateTime End { get; }

    private Duration(DateTime start, int filmDuration)
    {
        Start = start;
        End = start.AddMinutes(filmDuration);
    }

    public static Duration Create(DateTime start, int filmDuration)
    {
        if (filmDuration <= 0)
            throw new DomainArgumentException("Film duration can't be negative.");

        return new(start, filmDuration);
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Domain\ValueObjects\Email.cs
`$lang
using Cinema.Domain.Exceptions;
namespace Cinema.Domain.ValueObjects;

public sealed class Email
{
    public string Value { get; }

    private Email(string value)
    {
        Value = value.ToLowerInvariant();
    }

    public static Email Create(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
            throw new DomainArgumentException("Email can't be null or empty.");

        if (!IsValidEmail(value))
            throw new BusinessRuleException("Uncorrect Email type.");

        return new Email(value);
    }

    public static bool IsValidEmail(string email)
    {
        try
        {
            var address = new System.Net.Mail.MailAddress(email);

            return address.Address == email;
        }
        catch
        {
            return false;
        }
    }

    public override bool Equals(object? obj)
    {
        if (obj is not Email other) return false;

        return Value.ToLowerInvariant() == other.Value.ToLowerInvariant();
    }

    public override int GetHashCode() => Value.ToLowerInvariant().GetHashCode();
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Domain\ValueObjects\Position.cs
`$lang
using Cinema.Domain.Exceptions;

namespace Cinema.Domain.ValueObjects;

public class Position
{
    public int Raw { get; }
    public int Num { get; }

    private Position(int raw, int num)
    {
        Raw = raw;
        Num = num;
    }

    public static Position Create(int raw, int num)
    {
        if (raw <= 0 || num <= 0)
            throw new DomainArgumentException("Position can't be negative.");

        return new Position(raw, num);
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Domain\ValueObjects\Wallet.cs
`$lang
using Cinema.Domain.Exceptions;

namespace Cinema.Domain.ValueObjects;

public class Wallet
{
    public decimal Balance { get; private set; }

    private Wallet(decimal balance)
    {
        Balance = balance;
    }

    public static Wallet Create(decimal balance)
    {
        if (balance < 0)
            throw new BusinessRuleException("Balance can't be negative.");

        return new Wallet(balance);
    }

    public void Add(decimal amount)
    {
        if (amount < 0) throw new BusinessRuleException("Can't add negative amount.");

        Balance += amount;
    }

    public void Deduct(decimal amount)
    {
        if (amount < 0) throw new BusinessRuleException("Can't deduct negative amount.");

        Balance -= amount;
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\AppDbContext.cs
`$lang
using Microsoft.EntityFrameworkCore;
using Cinema.Infrastructure.DbEntities;

namespace Cinema.Infrastructure;

public class AppDbContext : Microsoft.EntityFrameworkCore.DbContext
{
    public AppDbContext(DbContextOptions<AppDbContext> options)
      : base(options)
    {

    }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        modelBuilder.ApplyConfigurationsFromAssembly(typeof(AppDbContext).Assembly);

        base.OnModelCreating(modelBuilder);
    }

    public DbSet<DbUser> Users => Set<DbUser>();
    public DbSet<DbBooking> Bookings => Set<DbBooking>();
    public DbSet<DbFilm> Films => Set<DbFilm>();
    public DbSet<DbSeat> Seats => Set<DbSeat>();
    public DbSet<DbSession> Sessions => Set<DbSession>();
    public DbSet<DbHall> Halls => Set<DbHall>();


}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Infrastructure.csproj
`$lang
<Project Sdk="Microsoft.NET.Sdk">

  <ItemGroup>
    <ProjectReference Include="..\Domain\Domain.csproj" />
    <ProjectReference Include="..\Application\Application.csproj" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="BCrypt.Net-Next" Version="4.0.3" />
    <PackageReference Include="Microsoft.EntityFrameworkCore" Version="9.0.9" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="9.0.9">
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="9.0.9">
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <PackageReference Include="Microsoft.Extensions.Options" Version="10.0.2" />
    <PackageReference Include="Npgsql.EntityFrameworkCore.PostgreSQL" Version="9.0.4" />
    <PackageReference Include="System.IdentityModel.Tokens.Jwt" Version="8.15.0" />
  </ItemGroup>

  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

</Project>

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\UnitOfWork.cs
`$lang
using Cinema.Application.Abstractions;
using Microsoft.EntityFrameworkCore.Storage;
using Cinema.Infrastructure.Exceptions;
using Microsoft.EntityFrameworkCore;
using Cinema.Application.Exceptions;

namespace Cinema.Infrastructure;

public class UnitOfWork : IUnitOfWork
{
    private readonly AppDbContext _context;
    private IDbContextTransaction? _transaction;

    public UnitOfWork(AppDbContext context)
    {
        _context = context;
    }

    public async Task BeginAsync(CancellationToken token)
    {
        _transaction = await _context.Database.BeginTransactionAsync(token);
    }

    public async Task CommitAsync(CancellationToken token)
    {
        try
        {
            await _context.SaveChangesAsync(token);
            await _transaction!.CommitAsync();
        }
        catch (DbUpdateConcurrencyException ex)
        {
            throw new ApplicationPersistenceException(ex.Message);
        }
        catch (DbUpdateException ex)
        {
            throw new ApplicationPersistenceException(ex.Message);
        }
    }

    public async Task RollbackAsync(CancellationToken token)
    {
        if (_transaction is not null)
        {
            await _transaction.RollbackAsync(token);
        }
    }

    public async Task SaveChangesAsync(CancellationToken token)
    {
        try
        {
            await _context.SaveChangesAsync(token);
        }
        catch (DbUpdateConcurrencyException ex)
        {
            throw new ApplicationPersistenceException(ex.Message);
        }
        catch (DbUpdateException ex)
        {
            throw new ApplicationPersistenceException(ex.Message);
        }
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Configurations\BookingConfiguration.cs
`$lang
using Cinema.Infrastructure.DbEntities;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Cinema.Infrastructure.Configurations;

public class BookingConfiguration : IEntityTypeConfiguration<DbBooking>
{
    public void Configure(EntityTypeBuilder<DbBooking> builder)
    {
        builder.HasKey(b => b.Id);

        builder
          .HasOne(b => b.Session)
          .WithMany()
          .HasForeignKey(b => b.SessionId);

        builder
          .HasOne(b => b.User)
          .WithMany(u => u.Bookings)
          .HasForeignKey(b => b.UserId)
          .OnDelete(DeleteBehavior.Cascade);

        builder
          .Property(b => b.Cost)
          .HasColumnType("decimal(18,2)");
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Configurations\FilmConfiguration.cs
`$lang
using Cinema.Infrastructure.DbEntities;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Cinema.Infrastructure.Configurations;

public class FilmConfiguration : IEntityTypeConfiguration<DbFilm>
{
    public void Configure(EntityTypeBuilder<DbFilm> builder)
    {
        builder.HasKey(f => f.Id);

        builder.Property(f => f.Title)
          .IsRequired();

        builder.Property(f => f.Price)
          .IsRequired()
          .HasColumnType("decimal(18,2)");
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Configurations\HallConfiguration.cs
`$lang
using Cinema.Infrastructure.DbEntities;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Cinema.Infrastructure.Configurations;

public class HallConfiguration : IEntityTypeConfiguration<DbHall>
{
    public void Configure(EntityTypeBuilder<DbHall> builder)
    {
        builder.HasKey(h => h.Id);

        builder
          .Property(h => h.Title)
          .IsRequired();

        builder
          .HasMany(h => h.Seats)
          .WithOne()
          .HasForeignKey(s => s.HallId);
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Configurations\SeatConfiguration.cs
`$lang
using Cinema.Infrastructure.DbEntities;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Cinema.Infrastructure.Configurations;

public class SeatConfiguration : IEntityTypeConfiguration<DbSeat>
{
    public void Configure(EntityTypeBuilder<DbSeat> builder)
    {
        builder.HasKey(s => s.Id);

        builder
          .Property(s => s.IsOccupied)
          .IsRequired();

        builder
          .Property(s => s.Raw)
          .IsRequired();

        builder
          .Property(s => s.Num)
          .IsRequired();
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Configurations\SessionConfiguration.cs
`$lang
using Cinema.Infrastructure.DbEntities;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Cinema.Infrastructure.Configurations;

public class SessionConfiguration : IEntityTypeConfiguration<DbSession>
{
    public void Configure(EntityTypeBuilder<DbSession> builder)
    {
        builder.HasKey(s => s.Id);

        builder
          .Property(s => s.Start)
          .IsRequired()
          .HasColumnType("timestamp without time zone");

        builder
          .Property(s => s.End)
          .IsRequired()
          .HasColumnType("timestamp without time zone");

        builder
         .HasOne(s => s.Hall)
         .WithMany()
         .HasForeignKey(s => s.HallId)
         .OnDelete(DeleteBehavior.Cascade);

        builder
          .HasOne(s => s.Film)
          .WithMany()
          .HasForeignKey(s => s.FilmId)
          .OnDelete(DeleteBehavior.Cascade);
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Configurations\UserConfiguration.cs
`$lang
using Cinema.Infrastructure.DbEntities;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Cinema.Infrastructure.Configurations;

public class UserConfiguration : IEntityTypeConfiguration<DbUser>
{
    public void Configure(EntityTypeBuilder<DbUser> builder)
    {
        builder.HasKey(u => u.Id);

        builder.Property(u => u.Name)
            .IsRequired();

        builder.Property(u => u.PasswordHash)
            .IsRequired();

        builder.Property(u => u.Email)
            .IsRequired();

        builder.HasIndex(u => u.Email).IsUnique();

        builder.Property(u => u.Role)
            .IsRequired()
            .HasConversion<int>();

        builder.Property(u => u.WalletBalance)
            .IsRequired()
            .HasColumnType("decimal(18,2)");

        builder
            .HasMany(u => u.Bookings)
            .WithOne(b => b.User)
            .HasForeignKey(b => b.UserId);
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\DbEntities\DbBooking.cs
`$lang
namespace Cinema.Infrastructure.DbEntities;

public class DbBooking
{
    public Guid Id { get; set; }

    public Guid UserId { get; set; }

    public DbUser? User { get; set; }

    public Guid SessionId { get; set; }

    public DbSession? Session { get; set; }

    public decimal Cost { get; set; }

    public List<Guid> Seats { get; set; } = new();
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\DbEntities\DbFilm.cs
`$lang
namespace Cinema.Infrastructure.DbEntities;

public class DbFilm
{
    public Guid Id { get; set; }

    public string Title { get; set; } = string.Empty;

    public Decimal Price { get; set; }

    public int Duration { get; set; }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\DbEntities\DbHall.cs
`$lang
namespace Cinema.Infrastructure.DbEntities;

public class DbHall
{
    public Guid Id { get; set; }

    public string Title { get; set; } = string.Empty;

    public List<DbSeat> Seats { get; set; } = new();
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\DbEntities\DbSeat.cs
`$lang
namespace Cinema.Infrastructure.DbEntities;

public class DbSeat
{
    public Guid Id { get; set; }

    public int Raw { get; set; }

    public bool IsOccupied { get; set; }

    public int Num { get; set; }

    public Guid HallId { get; set; }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\DbEntities\DbSession.cs
`$lang
namespace Cinema.Infrastructure.DbEntities;

public class DbSession
{
    public Guid Id { get; set; }

    public Guid HallId { get; set; }

    public Guid FilmId { get; set; }

    public DbHall? Hall { get; set; }

    public DbFilm? Film { get; set; }

    public DateTime Start { get; set; }

    public DateTime End { get; set; }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\DbEntities\DbUser.cs
`$lang
using Cinema.Domain.Enums;

namespace Cinema.Infrastructure.DbEntities;

public class DbUser
{
    public Guid Id { get; set; }

    public string Name { get; set; } = string.Empty;

    public string Email { get; set; } = string.Empty;

    public string PasswordHash { get; set; } = string.Empty;

    public Role Role { get; set; }

    public decimal WalletBalance { get; set; }

    public List<DbBooking> Bookings { get; set; } = new();
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Exceptions\InfrastructureConqurrencyException.cs
`$lang
namespace Cinema.Infrastructure.Exceptions;

public class InfrastructureConqurrencyException : InfrastructureException
{
    public InfrastructureConqurrencyException(string message)
      : base("Entity was modified concurrently", message)
    {

    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Exceptions\InfrastructureDbUpdateException.cs
`$lang
namespace Cinema.Infrastructure.Exceptions;

public class InfrastructureDbUpdateException : InfrastructureException
{
    public InfrastructureDbUpdateException(string message)
      : base("Failed to save entity", message)
    {
    }

}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Exceptions\InfrastructureException.cs
`$lang
namespace Cinema.Infrastructure.Exceptions;

public class InfrastructureException : Exception
{
    public string Title { get; }

    public InfrastructureException(string title, string message)
      : base(message)
    {
        Title = title;
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Helpers\BookingHelpers.cs
`$lang
using Cinema.Infrastructure.DbEntities;
using Cinema.Domain.Entities;

namespace Cinema.Infrastructure.Helpers;

public static class BookingHelper
{
    public static DbBooking ToDb(this Booking booking, AppDbContext context)
    {
        return new DbBooking
        {
            Id = booking.Id,
            UserId = booking.UserId,
            User = booking.User?.ToDb(context),
            SessionId = booking.SessionId,
            Session = booking.Session?.ToDb(context),
            Cost = booking.Cost,
            Seats = booking.Seats
        };
    }

    public static Booking ToDomain(this DbBooking dbBooking)
    {
        return new Booking
            (
                dbBooking.Id,
                dbBooking.UserId,
                dbBooking.User?.ToDomain(),
                dbBooking.SessionId,
                dbBooking.Session?.ToDomain(),
                dbBooking.Cost,
                dbBooking.Seats
            );
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Helpers\DbContextHelpers.cs
`$lang
using Microsoft.EntityFrameworkCore;

namespace Cinema.Infrastructure.Helpers;

public static class DbContextExtensions
{
    public static T AddOrAttach<T>(this DbContext context, T entity, bool isNew = false)
      where T : class
    {
        var set = context.Set<T>();

        var tracked = set.Local.FirstOrDefault(e => GetId(e).Equals(GetId(entity)));

        if (tracked != null)
        {
            return tracked;
        }

        if (isNew)
        {
            set.Add(entity);
        }
        else
        {
            set.Attach(entity);
        }
        return entity;

        static object GetId(T e) =>
          e.GetType().GetProperty("Id")!.GetValue(e)
          ?? throw new InvalidOperationException("Entity must have id");
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Helpers\FilmHelpers.cs
`$lang
using Cinema.Domain.Entities;
using Cinema.Infrastructure.DbEntities;

namespace Cinema.Infrastructure.Helpers;

public static class FilmHelpers
{
    public static DbFilm ToDb(this Film film, AppDbContext context)
    {
        var dbFilm = context.Films.Local.FirstOrDefault(f => f.Id == film.Id);

        if (dbFilm is not null)
        {
            return dbFilm;
        }
        return new DbFilm
        {
            Id = film.Id,
            Title = film.Title,
            Price = film.Price,
            Duration = film.Duration
        };
    }

    public static Film ToDomain(this DbFilm dbFilm)
    {
        return new Film
        (
            dbFilm.Id,
            dbFilm.Title,
            dbFilm.Price,
            dbFilm.Duration
        );
    }
}


`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Helpers\HallHelpers.cs
`$lang
using Cinema.Domain.Entities;
using Cinema.Infrastructure.DbEntities;

namespace Cinema.Infrastructure.Helpers;

public static class HallHelpers
{
    public static DbHall ToDb(this Hall hall, AppDbContext context)
    {
        return new DbHall
        {
            Id = hall.Id,
            Title = hall.Title,
            Seats = hall.Seats.Select(s => s.ToDb(context)).ToList()
        };
    }

    public static Hall ToDomain(this DbHall dbHall)
    {
        return new Hall
        (
            dbHall.Id,
            dbHall.Title,
            dbHall.Seats.Select(s => s.ToDomain()).ToList()
        );
    }
}


`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Helpers\SeatHelpers.cs
`$lang
using Cinema.Domain.Entities;
using Cinema.Domain.ValueObjects;
using Cinema.Infrastructure.DbEntities;

namespace Cinema.Infrastructure.Helpers;

public static class SeatHelpers
{
    public static DbSeat ToDb(this Seat seat, AppDbContext context)
    {
        return new DbSeat
        {
            Id = seat.Id,
            HallId = seat.HallId,
            Raw = seat.Position.Raw,
            Num = seat.Position.Num,
            IsOccupied = seat.IsOccupied
        };
    }

    public static Seat ToDomain(this DbSeat dbSeat)
    {
        return new Seat
        (
            dbSeat.Id,
            dbSeat.HallId,
            dbSeat.IsOccupied,
            Position.Create(dbSeat.Raw, dbSeat.Num)
        );
    }
}


`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Helpers\SessionHelpers.cs
`$lang
using Cinema.Domain.Entities;
using Cinema.Domain.ValueObjects;
using Cinema.Infrastructure.DbEntities;

namespace Cinema.Infrastructure.Helpers;

public static class SessionHelpers
{
    public static DbSession ToDb(this Session session, AppDbContext context)
    {
        return new DbSession
        {
            Id = session.Id,
            HallId = session.HallId,
            FilmId = session.FilmId,
            Hall = session.Hall?.ToDb(context),
            Film = session.Film?.ToDb(context),
            Start = session.Duration.Start,
            End = session.Duration.End
        };
    }

    public static Session ToDomain(this DbSession dbSession)
    {
        return new Session
        (
            dbSession.Id,
            dbSession.HallId,
            dbSession.Hall?.ToDomain(),
            dbSession.FilmId,
            dbSession.Film?.ToDomain(),
            Duration.Create(dbSession.Start, (int)dbSession.End.Subtract(dbSession.Start).TotalMinutes)
        );
    }
}


`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Helpers\UserHelpers.cs
`$lang
using Cinema.Domain.Entities;
using Cinema.Infrastructure.DbEntities;
using Cinema.Domain.ValueObjects;

namespace Cinema.Infrastructure.Helpers;

public static class UserHelpers
{
    public static List<DbBooking> BookingsToRemove(DbUser newUser, DbUser oldUser)
    {
        return oldUser.Bookings.Where(s => !newUser.Bookings.Contains(s)).ToList();
    }

    public static List<DbBooking> BookingsToAdd(DbUser newUser, DbUser oldUser)
    {
        return newUser.Bookings.Where(s => !oldUser.Bookings.Contains(s)).ToList();
    }


    public static DbUser ToDb(this User user, AppDbContext context)
    {
        return new DbUser
        {
            Id = user.Id,
            Name = user.Name,
            Email = user.Email.Value,
            PasswordHash = user.PasswordHash,
            Role = user.Role,
            WalletBalance = user.Wallet.Balance,
            Bookings = user.Bookings.Select(b => b.ToDb(context)).ToList()
        };
    }

    public static User ToDomain(this DbUser dbUser)
    {
        return new User
        (
            dbUser.Id,
            dbUser.Name,
            Email.Create(dbUser.Email),
            dbUser.PasswordHash,
            dbUser.Role,
            Wallet.Create(dbUser.WalletBalance),
            dbUser.Bookings.Select(b => b.ToDomain()).ToList()
        );
    }
}


`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Migrations\20260107204603_InitialCreate.cs
`$lang
using System;
using System.Collections.Generic;
using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace Infrastructure.Migrations
{
    /// <inheritdoc />
    public partial class InitialCreate : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.CreateTable(
                name: "Films",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    Title = table.Column<string>(type: "text", nullable: false),
                    Price = table.Column<decimal>(type: "numeric", nullable: false),
                    Duratioin = table.Column<int>(type: "integer", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_Films", x => x.Id);
                });

            migrationBuilder.CreateTable(
                name: "Halls",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    Title = table.Column<string>(type: "text", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_Halls", x => x.Id);
                });

            migrationBuilder.CreateTable(
                name: "Users",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    Name = table.Column<string>(type: "text", nullable: false),
                    PasswordHash = table.Column<string>(type: "text", nullable: false),
                    Role = table.Column<int>(type: "integer", nullable: false),
                    WalletBalance = table.Column<decimal>(type: "numeric", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_Users", x => x.Id);
                });

            migrationBuilder.CreateTable(
                name: "Seats",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    Raw = table.Column<int>(type: "integer", nullable: false),
                    IsOccupied = table.Column<bool>(type: "boolean", nullable: false),
                    Num = table.Column<int>(type: "integer", nullable: false),
                    HallId = table.Column<Guid>(type: "uuid", nullable: false),
                    DbHallId = table.Column<Guid>(type: "uuid", nullable: true)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_Seats", x => x.Id);
                    table.ForeignKey(
                        name: "FK_Seats_Halls_DbHallId",
                        column: x => x.DbHallId,
                        principalTable: "Halls",
                        principalColumn: "Id");
                });

            migrationBuilder.CreateTable(
                name: "Sessions",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    HallId = table.Column<Guid>(type: "uuid", nullable: false),
                    FilmId = table.Column<Guid>(type: "uuid", nullable: false),
                    Start = table.Column<TimeOnly>(type: "time without time zone", nullable: false),
                    End = table.Column<TimeOnly>(type: "time without time zone", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_Sessions", x => x.Id);
                    table.ForeignKey(
                        name: "FK_Sessions_Films_FilmId",
                        column: x => x.FilmId,
                        principalTable: "Films",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                    table.ForeignKey(
                        name: "FK_Sessions_Halls_HallId",
                        column: x => x.HallId,
                        principalTable: "Halls",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "Bookings",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    UserId = table.Column<Guid>(type: "uuid", nullable: false),
                    SessionId = table.Column<Guid>(type: "uuid", nullable: false),
                    Cost = table.Column<decimal>(type: "numeric", nullable: false),
                    Status = table.Column<int>(type: "integer", nullable: false),
                    Seats = table.Column<List<Guid>>(type: "uuid[]", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_Bookings", x => x.Id);
                    table.ForeignKey(
                        name: "FK_Bookings_Sessions_SessionId",
                        column: x => x.SessionId,
                        principalTable: "Sessions",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                    table.ForeignKey(
                        name: "FK_Bookings_Users_UserId",
                        column: x => x.UserId,
                        principalTable: "Users",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateIndex(
                name: "IX_Bookings_SessionId",
                table: "Bookings",
                column: "SessionId");

            migrationBuilder.CreateIndex(
                name: "IX_Bookings_UserId",
                table: "Bookings",
                column: "UserId");

            migrationBuilder.CreateIndex(
                name: "IX_Seats_DbHallId",
                table: "Seats",
                column: "DbHallId");

            migrationBuilder.CreateIndex(
                name: "IX_Sessions_FilmId",
                table: "Sessions",
                column: "FilmId");

            migrationBuilder.CreateIndex(
                name: "IX_Sessions_HallId",
                table: "Sessions",
                column: "HallId");
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropTable(
                name: "Bookings");

            migrationBuilder.DropTable(
                name: "Seats");

            migrationBuilder.DropTable(
                name: "Sessions");

            migrationBuilder.DropTable(
                name: "Users");

            migrationBuilder.DropTable(
                name: "Films");

            migrationBuilder.DropTable(
                name: "Halls");
        }
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Migrations\20260107204603_InitialCreate.Designer.cs
`$lang
// <auto-generated />
using System;
using System.Collections.Generic;
using Cinema.Infrastructure;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;

#nullable disable

namespace Infrastructure.Migrations
{
    [DbContext(typeof(AppDbContext))]
    [Migration("20260107204603_InitialCreate")]
    partial class InitialCreate
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "9.0.9")
                .HasAnnotation("Relational:MaxIdentifierLength", 63);

            NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbBooking", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<decimal>("Cost")
                        .HasColumnType("numeric");

                    b.PrimitiveCollection<List<Guid>>("Seats")
                        .IsRequired()
                        .HasColumnType("uuid[]");

                    b.Property<Guid>("SessionId")
                        .HasColumnType("uuid");

                    b.Property<int>("Status")
                        .HasColumnType("integer");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("SessionId");

                    b.HasIndex("UserId");

                    b.ToTable("Bookings");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbFilm", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<int>("Duratioin")
                        .HasColumnType("integer");

                    b.Property<decimal>("Price")
                        .HasColumnType("numeric");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasColumnType("text");

                    b.HasKey("Id");

                    b.ToTable("Films");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbHall", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasColumnType("text");

                    b.HasKey("Id");

                    b.ToTable("Halls");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSeat", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<Guid?>("DbHallId")
                        .HasColumnType("uuid");

                    b.Property<Guid>("HallId")
                        .HasColumnType("uuid");

                    b.Property<bool>("IsOccupied")
                        .HasColumnType("boolean");

                    b.Property<int>("Num")
                        .HasColumnType("integer");

                    b.Property<int>("Raw")
                        .HasColumnType("integer");

                    b.HasKey("Id");

                    b.HasIndex("DbHallId");

                    b.ToTable("Seats");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSession", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<TimeOnly>("End")
                        .HasColumnType("time without time zone");

                    b.Property<Guid>("FilmId")
                        .HasColumnType("uuid");

                    b.Property<Guid>("HallId")
                        .HasColumnType("uuid");

                    b.Property<TimeOnly>("Start")
                        .HasColumnType("time without time zone");

                    b.HasKey("Id");

                    b.HasIndex("FilmId");

                    b.HasIndex("HallId");

                    b.ToTable("Sessions");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbUser", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<string>("PasswordHash")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<int>("Role")
                        .HasColumnType("integer");

                    b.Property<decimal>("WalletBalance")
                        .HasColumnType("numeric");

                    b.HasKey("Id");

                    b.ToTable("Users");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbBooking", b =>
                {
                    b.HasOne("Cinema.Infrastructure.DbEntities.DbSession", "Session")
                        .WithMany("Bookings")
                        .HasForeignKey("SessionId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Cinema.Infrastructure.DbEntities.DbUser", "User")
                        .WithMany("Bookings")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Session");

                    b.Navigation("User");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSeat", b =>
                {
                    b.HasOne("Cinema.Infrastructure.DbEntities.DbHall", null)
                        .WithMany("Seats")
                        .HasForeignKey("DbHallId");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSession", b =>
                {
                    b.HasOne("Cinema.Infrastructure.DbEntities.DbFilm", "Film")
                        .WithMany()
                        .HasForeignKey("FilmId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Cinema.Infrastructure.DbEntities.DbHall", "Hall")
                        .WithMany()
                        .HasForeignKey("HallId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Film");

                    b.Navigation("Hall");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbHall", b =>
                {
                    b.Navigation("Seats");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSession", b =>
                {
                    b.Navigation("Bookings");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbUser", b =>
                {
                    b.Navigation("Bookings");
                });
#pragma warning restore 612, 618
        }
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Migrations\20260108174903_ApplyConfiguration.cs
`$lang
using System;
using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace Infrastructure.Migrations
{
    /// <inheritdoc />
    public partial class ApplyConfiguration : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropForeignKey(
                name: "FK_Seats_Halls_DbHallId",
                table: "Seats");

            migrationBuilder.DropIndex(
                name: "IX_Seats_DbHallId",
                table: "Seats");

            migrationBuilder.DropColumn(
                name: "DbHallId",
                table: "Seats");

            migrationBuilder.AlterColumn<decimal>(
                name: "WalletBalance",
                table: "Users",
                type: "numeric(18,2)",
                nullable: false,
                oldClrType: typeof(decimal),
                oldType: "numeric");

            migrationBuilder.AlterColumn<TimeSpan>(
                name: "Start",
                table: "Sessions",
                type: "interval",
                nullable: false,
                oldClrType: typeof(TimeOnly),
                oldType: "time without time zone");

            migrationBuilder.AlterColumn<TimeSpan>(
                name: "End",
                table: "Sessions",
                type: "interval",
                nullable: false,
                oldClrType: typeof(TimeOnly),
                oldType: "time without time zone");

            migrationBuilder.AlterColumn<decimal>(
                name: "Price",
                table: "Films",
                type: "numeric(18,2)",
                nullable: false,
                oldClrType: typeof(decimal),
                oldType: "numeric");

            migrationBuilder.AlterColumn<decimal>(
                name: "Cost",
                table: "Bookings",
                type: "numeric(18,2)",
                nullable: false,
                oldClrType: typeof(decimal),
                oldType: "numeric");

            migrationBuilder.CreateIndex(
                name: "IX_Seats_HallId",
                table: "Seats",
                column: "HallId");

            migrationBuilder.AddForeignKey(
                name: "FK_Seats_Halls_HallId",
                table: "Seats",
                column: "HallId",
                principalTable: "Halls",
                principalColumn: "Id",
                onDelete: ReferentialAction.Cascade);
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropForeignKey(
                name: "FK_Seats_Halls_HallId",
                table: "Seats");

            migrationBuilder.DropIndex(
                name: "IX_Seats_HallId",
                table: "Seats");

            migrationBuilder.AlterColumn<decimal>(
                name: "WalletBalance",
                table: "Users",
                type: "numeric",
                nullable: false,
                oldClrType: typeof(decimal),
                oldType: "numeric(18,2)");

            migrationBuilder.AlterColumn<TimeOnly>(
                name: "Start",
                table: "Sessions",
                type: "time without time zone",
                nullable: false,
                oldClrType: typeof(TimeSpan),
                oldType: "interval");

            migrationBuilder.AlterColumn<TimeOnly>(
                name: "End",
                table: "Sessions",
                type: "time without time zone",
                nullable: false,
                oldClrType: typeof(TimeSpan),
                oldType: "interval");

            migrationBuilder.AddColumn<Guid>(
                name: "DbHallId",
                table: "Seats",
                type: "uuid",
                nullable: true);

            migrationBuilder.AlterColumn<decimal>(
                name: "Price",
                table: "Films",
                type: "numeric",
                nullable: false,
                oldClrType: typeof(decimal),
                oldType: "numeric(18,2)");

            migrationBuilder.AlterColumn<decimal>(
                name: "Cost",
                table: "Bookings",
                type: "numeric",
                nullable: false,
                oldClrType: typeof(decimal),
                oldType: "numeric(18,2)");

            migrationBuilder.CreateIndex(
                name: "IX_Seats_DbHallId",
                table: "Seats",
                column: "DbHallId");

            migrationBuilder.AddForeignKey(
                name: "FK_Seats_Halls_DbHallId",
                table: "Seats",
                column: "DbHallId",
                principalTable: "Halls",
                principalColumn: "Id");
        }
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Migrations\20260108174903_ApplyConfiguration.Designer.cs
`$lang
// <auto-generated />
using System;
using System.Collections.Generic;
using Cinema.Infrastructure;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;

#nullable disable

namespace Infrastructure.Migrations
{
    [DbContext(typeof(AppDbContext))]
    [Migration("20260108174903_ApplyConfiguration")]
    partial class ApplyConfiguration
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "9.0.9")
                .HasAnnotation("Relational:MaxIdentifierLength", 63);

            NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbBooking", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<decimal>("Cost")
                        .HasColumnType("decimal(18,2)");

                    b.PrimitiveCollection<List<Guid>>("Seats")
                        .IsRequired()
                        .HasColumnType("uuid[]");

                    b.Property<Guid>("SessionId")
                        .HasColumnType("uuid");

                    b.Property<int>("Status")
                        .HasColumnType("integer");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("SessionId");

                    b.HasIndex("UserId");

                    b.ToTable("Bookings");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbFilm", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<int>("Duratioin")
                        .HasColumnType("integer");

                    b.Property<decimal>("Price")
                        .HasColumnType("decimal(18,2)");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasColumnType("text");

                    b.HasKey("Id");

                    b.ToTable("Films");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbHall", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasColumnType("text");

                    b.HasKey("Id");

                    b.ToTable("Halls");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSeat", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<Guid>("HallId")
                        .HasColumnType("uuid");

                    b.Property<bool>("IsOccupied")
                        .HasColumnType("boolean");

                    b.Property<int>("Num")
                        .HasColumnType("integer");

                    b.Property<int>("Raw")
                        .HasColumnType("integer");

                    b.HasKey("Id");

                    b.HasIndex("HallId");

                    b.ToTable("Seats");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSession", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<TimeSpan>("End")
                        .HasColumnType("interval");

                    b.Property<Guid>("FilmId")
                        .HasColumnType("uuid");

                    b.Property<Guid>("HallId")
                        .HasColumnType("uuid");

                    b.Property<TimeSpan>("Start")
                        .HasColumnType("interval");

                    b.HasKey("Id");

                    b.HasIndex("FilmId");

                    b.HasIndex("HallId");

                    b.ToTable("Sessions");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbUser", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<string>("PasswordHash")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<int>("Role")
                        .HasColumnType("integer");

                    b.Property<decimal>("WalletBalance")
                        .HasColumnType("decimal(18,2)");

                    b.HasKey("Id");

                    b.ToTable("Users");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbBooking", b =>
                {
                    b.HasOne("Cinema.Infrastructure.DbEntities.DbSession", "Session")
                        .WithMany("Bookings")
                        .HasForeignKey("SessionId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Cinema.Infrastructure.DbEntities.DbUser", "User")
                        .WithMany("Bookings")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Session");

                    b.Navigation("User");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSeat", b =>
                {
                    b.HasOne("Cinema.Infrastructure.DbEntities.DbHall", null)
                        .WithMany("Seats")
                        .HasForeignKey("HallId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSession", b =>
                {
                    b.HasOne("Cinema.Infrastructure.DbEntities.DbFilm", "Film")
                        .WithMany()
                        .HasForeignKey("FilmId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Cinema.Infrastructure.DbEntities.DbHall", "Hall")
                        .WithMany()
                        .HasForeignKey("HallId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Film");

                    b.Navigation("Hall");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbHall", b =>
                {
                    b.Navigation("Seats");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSession", b =>
                {
                    b.Navigation("Bookings");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbUser", b =>
                {
                    b.Navigation("Bookings");
                });
#pragma warning restore 612, 618
        }
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Migrations\20260109211237_Session.TimeStamp to DateTime and Navigation nullable.cs
`$lang
using System;
using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace Infrastructure.Migrations
{
    /// <inheritdoc />
    public partial class SessionTimeStamptoDateTimeandNavigationnullable : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropColumn(
            name: "Start",
            table: "Sessions");

            migrationBuilder.AddColumn<DateTime>(
            name: "Start",
            table: "Sessions",
            type: "timestamp without time zone",
            nullable: false,
            defaultValueSql: "NOW()");
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropColumn(
            name: "Start",
            table: "Sessions");

            migrationBuilder.AddColumn<TimeSpan>( //     interval
            name: "Start",
            table: "Sessions",
            type: "interval",
            nullable: false,
            defaultValue: TimeSpan.Zero);
        }
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Migrations\20260109211237_Session.TimeStamp to DateTime and Navigation nullable.Designer.cs
`$lang
// <auto-generated />
using System;
using System.Collections.Generic;
using Cinema.Infrastructure;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;

#nullable disable

namespace Infrastructure.Migrations
{
    [DbContext(typeof(AppDbContext))]
    [Migration("20260109211237_Session.TimeStamp to DateTime and Navigation nullable")]
    partial class SessionTimeStamptoDateTimeandNavigationnullable
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "9.0.9")
                .HasAnnotation("Relational:MaxIdentifierLength", 63);

            NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbBooking", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<decimal>("Cost")
                        .HasColumnType("decimal(18,2)");

                    b.PrimitiveCollection<List<Guid>>("Seats")
                        .IsRequired()
                        .HasColumnType("uuid[]");

                    b.Property<Guid>("SessionId")
                        .HasColumnType("uuid");

                    b.Property<int>("Status")
                        .HasColumnType("integer");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("SessionId");

                    b.HasIndex("UserId");

                    b.ToTable("Bookings");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbFilm", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<int>("Duratioin")
                        .HasColumnType("integer");

                    b.Property<decimal>("Price")
                        .HasColumnType("decimal(18,2)");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasColumnType("text");

                    b.HasKey("Id");

                    b.ToTable("Films");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbHall", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasColumnType("text");

                    b.HasKey("Id");

                    b.ToTable("Halls");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSeat", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<Guid>("HallId")
                        .HasColumnType("uuid");

                    b.Property<bool>("IsOccupied")
                        .HasColumnType("boolean");

                    b.Property<int>("Num")
                        .HasColumnType("integer");

                    b.Property<int>("Raw")
                        .HasColumnType("integer");

                    b.HasKey("Id");

                    b.HasIndex("HallId");

                    b.ToTable("Seats");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSession", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTime>("End")
                        .HasColumnType("timestamp without time zone");

                    b.Property<Guid>("FilmId")
                        .HasColumnType("uuid");

                    b.Property<Guid>("HallId")
                        .HasColumnType("uuid");

                    b.Property<DateTime>("Start")
                        .HasColumnType("timestamp without time zone");

                    b.HasKey("Id");

                    b.HasIndex("FilmId");

                    b.HasIndex("HallId");

                    b.ToTable("Sessions");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbUser", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<string>("PasswordHash")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<int>("Role")
                        .HasColumnType("integer");

                    b.Property<decimal>("WalletBalance")
                        .HasColumnType("decimal(18,2)");

                    b.HasKey("Id");

                    b.ToTable("Users");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbBooking", b =>
                {
                    b.HasOne("Cinema.Infrastructure.DbEntities.DbSession", "Session")
                        .WithMany("Bookings")
                        .HasForeignKey("SessionId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Cinema.Infrastructure.DbEntities.DbUser", "User")
                        .WithMany("Bookings")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Session");

                    b.Navigation("User");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSeat", b =>
                {
                    b.HasOne("Cinema.Infrastructure.DbEntities.DbHall", null)
                        .WithMany("Seats")
                        .HasForeignKey("HallId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSession", b =>
                {
                    b.HasOne("Cinema.Infrastructure.DbEntities.DbFilm", "Film")
                        .WithMany()
                        .HasForeignKey("FilmId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Cinema.Infrastructure.DbEntities.DbHall", "Hall")
                        .WithMany()
                        .HasForeignKey("HallId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Film");

                    b.Navigation("Hall");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbHall", b =>
                {
                    b.Navigation("Seats");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSession", b =>
                {
                    b.Navigation("Bookings");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbUser", b =>
                {
                    b.Navigation("Bookings");
                });
#pragma warning restore 612, 618
        }
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Migrations\20260112175047_DomainUpdate.cs
`$lang
using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace Infrastructure.Migrations
{
    /// <inheritdoc />
    public partial class DomainUpdate : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.RenameColumn(
                name: "Duratioin",
                table: "Films",
                newName: "Duration");

            migrationBuilder.AddColumn<string>(
                name: "Email",
                table: "Users",
                type: "text",
                nullable: false,
                defaultValue: "");

            migrationBuilder.CreateIndex(
                name: "IX_Users_Email",
                table: "Users",
                column: "Email",
                unique: true);
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropIndex(
                name: "IX_Users_Email",
                table: "Users");

            migrationBuilder.DropColumn(
                name: "Email",
                table: "Users");

            migrationBuilder.RenameColumn(
                name: "Duration",
                table: "Films",
                newName: "Duratioin");
        }
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Migrations\20260112175047_DomainUpdate.Designer.cs
`$lang
// <auto-generated />
using System;
using System.Collections.Generic;
using Cinema.Infrastructure;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;

#nullable disable

namespace Infrastructure.Migrations
{
    [DbContext(typeof(AppDbContext))]
    [Migration("20260112175047_DomainUpdate")]
    partial class DomainUpdate
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "9.0.9")
                .HasAnnotation("Relational:MaxIdentifierLength", 63);

            NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbBooking", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<decimal>("Cost")
                        .HasColumnType("decimal(18,2)");

                    b.PrimitiveCollection<List<Guid>>("Seats")
                        .IsRequired()
                        .HasColumnType("uuid[]");

                    b.Property<Guid>("SessionId")
                        .HasColumnType("uuid");

                    b.Property<int>("Status")
                        .HasColumnType("integer");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("SessionId");

                    b.HasIndex("UserId");

                    b.ToTable("Bookings");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbFilm", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<int>("Duration")
                        .HasColumnType("integer");

                    b.Property<decimal>("Price")
                        .HasColumnType("decimal(18,2)");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasColumnType("text");

                    b.HasKey("Id");

                    b.ToTable("Films");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbHall", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasColumnType("text");

                    b.HasKey("Id");

                    b.ToTable("Halls");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSeat", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<Guid>("HallId")
                        .HasColumnType("uuid");

                    b.Property<bool>("IsOccupied")
                        .HasColumnType("boolean");

                    b.Property<int>("Num")
                        .HasColumnType("integer");

                    b.Property<int>("Raw")
                        .HasColumnType("integer");

                    b.HasKey("Id");

                    b.HasIndex("HallId");

                    b.ToTable("Seats");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSession", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTime>("End")
                        .HasColumnType("timestamp without time zone");

                    b.Property<Guid>("FilmId")
                        .HasColumnType("uuid");

                    b.Property<Guid>("HallId")
                        .HasColumnType("uuid");

                    b.Property<DateTime>("Start")
                        .HasColumnType("timestamp without time zone");

                    b.HasKey("Id");

                    b.HasIndex("FilmId");

                    b.HasIndex("HallId");

                    b.ToTable("Sessions");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbUser", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<string>("Email")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<string>("PasswordHash")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<int>("Role")
                        .HasColumnType("integer");

                    b.Property<decimal>("WalletBalance")
                        .HasColumnType("decimal(18,2)");

                    b.HasKey("Id");

                    b.HasIndex("Email")
                        .IsUnique();

                    b.ToTable("Users");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbBooking", b =>
                {
                    b.HasOne("Cinema.Infrastructure.DbEntities.DbSession", "Session")
                        .WithMany("Bookings")
                        .HasForeignKey("SessionId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Cinema.Infrastructure.DbEntities.DbUser", "User")
                        .WithMany("Bookings")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Session");

                    b.Navigation("User");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSeat", b =>
                {
                    b.HasOne("Cinema.Infrastructure.DbEntities.DbHall", null)
                        .WithMany("Seats")
                        .HasForeignKey("HallId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSession", b =>
                {
                    b.HasOne("Cinema.Infrastructure.DbEntities.DbFilm", "Film")
                        .WithMany()
                        .HasForeignKey("FilmId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Cinema.Infrastructure.DbEntities.DbHall", "Hall")
                        .WithMany()
                        .HasForeignKey("HallId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Film");

                    b.Navigation("Hall");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbHall", b =>
                {
                    b.Navigation("Seats");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSession", b =>
                {
                    b.Navigation("Bookings");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbUser", b =>
                {
                    b.Navigation("Bookings");
                });
#pragma warning restore 612, 618
        }
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Migrations\20260114131851_Fix bugs.cs
`$lang
using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace Infrastructure.Migrations
{
    /// <inheritdoc />
    public partial class Fixbugs : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropColumn(
                name: "Status",
                table: "Bookings");
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.AddColumn<int>(
                name: "Status",
                table: "Bookings",
                type: "integer",
                nullable: false,
                defaultValue: 0);
        }
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Migrations\20260114131851_Fix bugs.Designer.cs
`$lang
// <auto-generated />
using System;
using System.Collections.Generic;
using Cinema.Infrastructure;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;

#nullable disable

namespace Infrastructure.Migrations
{
    [DbContext(typeof(AppDbContext))]
    [Migration("20260114131851_Fix bugs")]
    partial class Fixbugs
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "9.0.9")
                .HasAnnotation("Relational:MaxIdentifierLength", 63);

            NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbBooking", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<decimal>("Cost")
                        .HasColumnType("decimal(18,2)");

                    b.PrimitiveCollection<List<Guid>>("Seats")
                        .IsRequired()
                        .HasColumnType("uuid[]");

                    b.Property<Guid>("SessionId")
                        .HasColumnType("uuid");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("SessionId");

                    b.HasIndex("UserId");

                    b.ToTable("Bookings");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbFilm", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<int>("Duration")
                        .HasColumnType("integer");

                    b.Property<decimal>("Price")
                        .HasColumnType("decimal(18,2)");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasColumnType("text");

                    b.HasKey("Id");

                    b.ToTable("Films");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbHall", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasColumnType("text");

                    b.HasKey("Id");

                    b.ToTable("Halls");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSeat", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<Guid>("HallId")
                        .HasColumnType("uuid");

                    b.Property<bool>("IsOccupied")
                        .HasColumnType("boolean");

                    b.Property<int>("Num")
                        .HasColumnType("integer");

                    b.Property<int>("Raw")
                        .HasColumnType("integer");

                    b.HasKey("Id");

                    b.HasIndex("HallId");

                    b.ToTable("Seats");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSession", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTime>("End")
                        .HasColumnType("timestamp without time zone");

                    b.Property<Guid>("FilmId")
                        .HasColumnType("uuid");

                    b.Property<Guid>("HallId")
                        .HasColumnType("uuid");

                    b.Property<DateTime>("Start")
                        .HasColumnType("timestamp without time zone");

                    b.HasKey("Id");

                    b.HasIndex("FilmId");

                    b.HasIndex("HallId");

                    b.ToTable("Sessions");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbUser", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<string>("Email")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<string>("PasswordHash")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<int>("Role")
                        .HasColumnType("integer");

                    b.Property<decimal>("WalletBalance")
                        .HasColumnType("decimal(18,2)");

                    b.HasKey("Id");

                    b.HasIndex("Email")
                        .IsUnique();

                    b.ToTable("Users");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbBooking", b =>
                {
                    b.HasOne("Cinema.Infrastructure.DbEntities.DbSession", "Session")
                        .WithMany("Bookings")
                        .HasForeignKey("SessionId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Cinema.Infrastructure.DbEntities.DbUser", "User")
                        .WithMany("Bookings")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Session");

                    b.Navigation("User");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSeat", b =>
                {
                    b.HasOne("Cinema.Infrastructure.DbEntities.DbHall", null)
                        .WithMany("Seats")
                        .HasForeignKey("HallId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSession", b =>
                {
                    b.HasOne("Cinema.Infrastructure.DbEntities.DbFilm", "Film")
                        .WithMany()
                        .HasForeignKey("FilmId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Cinema.Infrastructure.DbEntities.DbHall", "Hall")
                        .WithMany()
                        .HasForeignKey("HallId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Film");

                    b.Navigation("Hall");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbHall", b =>
                {
                    b.Navigation("Seats");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSession", b =>
                {
                    b.Navigation("Bookings");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbUser", b =>
                {
                    b.Navigation("Bookings");
                });
#pragma warning restore 612, 618
        }
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Migrations\20260119150921_SessionUpdate.cs
`$lang
using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace Infrastructure.Migrations
{
    /// <inheritdoc />
    public partial class SessionUpdate : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {

        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {

        }
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Migrations\20260119150921_SessionUpdate.Designer.cs
`$lang
// <auto-generated />
using System;
using System.Collections.Generic;
using Cinema.Infrastructure;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;

#nullable disable

namespace Infrastructure.Migrations
{
    [DbContext(typeof(AppDbContext))]
    [Migration("20260119150921_SessionUpdate")]
    partial class SessionUpdate
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "9.0.9")
                .HasAnnotation("Relational:MaxIdentifierLength", 63);

            NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbBooking", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<decimal>("Cost")
                        .HasColumnType("decimal(18,2)");

                    b.PrimitiveCollection<List<Guid>>("Seats")
                        .IsRequired()
                        .HasColumnType("uuid[]");

                    b.Property<Guid>("SessionId")
                        .HasColumnType("uuid");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("SessionId");

                    b.HasIndex("UserId");

                    b.ToTable("Bookings");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbFilm", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<int>("Duration")
                        .HasColumnType("integer");

                    b.Property<decimal>("Price")
                        .HasColumnType("decimal(18,2)");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasColumnType("text");

                    b.HasKey("Id");

                    b.ToTable("Films");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbHall", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasColumnType("text");

                    b.HasKey("Id");

                    b.ToTable("Halls");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSeat", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<Guid>("HallId")
                        .HasColumnType("uuid");

                    b.Property<bool>("IsOccupied")
                        .HasColumnType("boolean");

                    b.Property<int>("Num")
                        .HasColumnType("integer");

                    b.Property<int>("Raw")
                        .HasColumnType("integer");

                    b.HasKey("Id");

                    b.HasIndex("HallId");

                    b.ToTable("Seats");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSession", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTime>("End")
                        .HasColumnType("timestamp without time zone");

                    b.Property<Guid>("FilmId")
                        .HasColumnType("uuid");

                    b.Property<Guid>("HallId")
                        .HasColumnType("uuid");

                    b.Property<DateTime>("Start")
                        .HasColumnType("timestamp without time zone");

                    b.HasKey("Id");

                    b.HasIndex("FilmId");

                    b.HasIndex("HallId");

                    b.ToTable("Sessions");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbUser", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<string>("Email")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<string>("PasswordHash")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<int>("Role")
                        .HasColumnType("integer");

                    b.Property<decimal>("WalletBalance")
                        .HasColumnType("decimal(18,2)");

                    b.HasKey("Id");

                    b.HasIndex("Email")
                        .IsUnique();

                    b.ToTable("Users");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbBooking", b =>
                {
                    b.HasOne("Cinema.Infrastructure.DbEntities.DbSession", "Session")
                        .WithMany()
                        .HasForeignKey("SessionId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Cinema.Infrastructure.DbEntities.DbUser", "User")
                        .WithMany("Bookings")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Session");

                    b.Navigation("User");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSeat", b =>
                {
                    b.HasOne("Cinema.Infrastructure.DbEntities.DbHall", null)
                        .WithMany("Seats")
                        .HasForeignKey("HallId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSession", b =>
                {
                    b.HasOne("Cinema.Infrastructure.DbEntities.DbFilm", "Film")
                        .WithMany()
                        .HasForeignKey("FilmId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Cinema.Infrastructure.DbEntities.DbHall", "Hall")
                        .WithMany()
                        .HasForeignKey("HallId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Film");

                    b.Navigation("Hall");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbHall", b =>
                {
                    b.Navigation("Seats");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbUser", b =>
                {
                    b.Navigation("Bookings");
                });
#pragma warning restore 612, 618
        }
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Migrations\AppDbContextModelSnapshot.cs
`$lang
// <auto-generated />
using System;
using System.Collections.Generic;
using Cinema.Infrastructure;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;

#nullable disable

namespace Infrastructure.Migrations
{
    [DbContext(typeof(AppDbContext))]
    partial class AppDbContextModelSnapshot : ModelSnapshot
    {
        protected override void BuildModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasAnnotation("ProductVersion", "9.0.9")
                .HasAnnotation("Relational:MaxIdentifierLength", 63);

            NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbBooking", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<decimal>("Cost")
                        .HasColumnType("decimal(18,2)");

                    b.PrimitiveCollection<List<Guid>>("Seats")
                        .IsRequired()
                        .HasColumnType("uuid[]");

                    b.Property<Guid>("SessionId")
                        .HasColumnType("uuid");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("SessionId");

                    b.HasIndex("UserId");

                    b.ToTable("Bookings");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbFilm", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<int>("Duration")
                        .HasColumnType("integer");

                    b.Property<decimal>("Price")
                        .HasColumnType("decimal(18,2)");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasColumnType("text");

                    b.HasKey("Id");

                    b.ToTable("Films");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbHall", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasColumnType("text");

                    b.HasKey("Id");

                    b.ToTable("Halls");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSeat", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<Guid>("HallId")
                        .HasColumnType("uuid");

                    b.Property<bool>("IsOccupied")
                        .HasColumnType("boolean");

                    b.Property<int>("Num")
                        .HasColumnType("integer");

                    b.Property<int>("Raw")
                        .HasColumnType("integer");

                    b.HasKey("Id");

                    b.HasIndex("HallId");

                    b.ToTable("Seats");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSession", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTime>("End")
                        .HasColumnType("timestamp without time zone");

                    b.Property<Guid>("FilmId")
                        .HasColumnType("uuid");

                    b.Property<Guid>("HallId")
                        .HasColumnType("uuid");

                    b.Property<DateTime>("Start")
                        .HasColumnType("timestamp without time zone");

                    b.HasKey("Id");

                    b.HasIndex("FilmId");

                    b.HasIndex("HallId");

                    b.ToTable("Sessions");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbUser", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<string>("Email")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<string>("PasswordHash")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<int>("Role")
                        .HasColumnType("integer");

                    b.Property<decimal>("WalletBalance")
                        .HasColumnType("decimal(18,2)");

                    b.HasKey("Id");

                    b.HasIndex("Email")
                        .IsUnique();

                    b.ToTable("Users");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbBooking", b =>
                {
                    b.HasOne("Cinema.Infrastructure.DbEntities.DbSession", "Session")
                        .WithMany()
                        .HasForeignKey("SessionId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Cinema.Infrastructure.DbEntities.DbUser", "User")
                        .WithMany("Bookings")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Session");

                    b.Navigation("User");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSeat", b =>
                {
                    b.HasOne("Cinema.Infrastructure.DbEntities.DbHall", null)
                        .WithMany("Seats")
                        .HasForeignKey("HallId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbSession", b =>
                {
                    b.HasOne("Cinema.Infrastructure.DbEntities.DbFilm", "Film")
                        .WithMany()
                        .HasForeignKey("FilmId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Cinema.Infrastructure.DbEntities.DbHall", "Hall")
                        .WithMany()
                        .HasForeignKey("HallId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Film");

                    b.Navigation("Hall");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbHall", b =>
                {
                    b.Navigation("Seats");
                });

            modelBuilder.Entity("Cinema.Infrastructure.DbEntities.DbUser", b =>
                {
                    b.Navigation("Bookings");
                });
#pragma warning restore 612, 618
        }
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Repositories\BookingRepository.cs
`$lang
using Cinema.Domain.Entities;
using Cinema.Infrastructure.DbEntities;
using Cinema.Application.Abstractions.IRepositories;
using Microsoft.EntityFrameworkCore;
using System.Runtime.CompilerServices;
using Cinema.Infrastructure.Helpers;
using Cinema.Application.Abstractions;

namespace Cinema.Infrastructure.Repositories;


public class BookingRepository : IBookingRepository
{
    private readonly AppDbContext _context;
    private readonly IUnitOfWork _uow;

    public BookingRepository(AppDbContext context, IUnitOfWork uow)
    {
        _context = context;
        _uow = uow;
    }

    public async Task<Booking?> GetByIdAsync(Guid id, CancellationToken token)
      => (await _context.Bookings.FindAsync(id, token))?.ToDomain();

    public async Task<Booking?> GetByIdWithNavigationPropertiesAsync(Guid id, CancellationToken token)
      => (await _context.Bookings
                                              .Include(b => b.Session)
                                                .ThenInclude(s => s!.Film)
                                              .Include(b => b.Session)
                                                .ThenInclude(s => s!.Hall)
                                              .Include(b => b.User)
                                              .FirstOrDefaultAsync(b => b.Id == id, token))
                                              ?.ToDomain();

    public async IAsyncEnumerable<Booking> GetAllAsync([EnumeratorCancellation] CancellationToken token)
    {
        await foreach (var booking in _context.Bookings
                                                .AsNoTracking()
                                                .AsAsyncEnumerable())
        {
            yield return booking.ToDomain();
        }
    }

    public async IAsyncEnumerable<Booking> GetByUserIdAsync(Guid id, [EnumeratorCancellation] CancellationToken token)
    {
        await foreach (var booking in _context.Bookings
                                                .AsNoTracking()
                                                .Where(b => b.UserId == id)
                                                .AsAsyncEnumerable())
        {
            yield return booking.ToDomain();
        }
    }

    public async Task<Booking?> CreateAsync(Booking entity, CancellationToken token)
    {
        DbBooking dbBooking = entity.ToDb(_context);

        await _context.Bookings.AddAsync(dbBooking, token);

        await _uow.SaveChangesAsync(token);

        return entity;
    }

    public async Task<Booking?> UpdateAsync(Booking entity, CancellationToken token)
    {
        var booking = await _context.Bookings.FindAsync(entity.Id, token);

        if (booking is null) return null;

        booking.Seats = entity.Seats;

        await _uow.SaveChangesAsync();

        return booking.ToDomain();
    }

    public async Task<bool> DeleteAsync(Guid id, CancellationToken token)
    {
        var booking = await _context.Bookings.FindAsync(id, token);

        if (booking is null) return false;

        _context.Bookings.Remove(booking);

        await _uow.SaveChangesAsync();

        return true;
    }


}




`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Repositories\FilmRepository.cs
`$lang
using Cinema.Domain.Entities;
using Cinema.Infrastructure.DbEntities;
using Cinema.Application.Abstractions.IRepositories;
using static Cinema.Infrastructure.Helpers.FilmHelpers;
using System.Runtime.CompilerServices;
using Microsoft.EntityFrameworkCore;
using Cinema.Infrastructure.Helpers;
using Cinema.Application.Abstractions;

namespace Cinema.Infrastructure.Repositories;

public class FilmRepository : IFilmRepository
{
    private readonly AppDbContext _context;
    private readonly IUnitOfWork _uow;

    public FilmRepository(AppDbContext context, IUnitOfWork uow)
    {
        _context = context;
        _uow = uow;
    }

    public async Task<Film?> GetByIdAsync(Guid id, CancellationToken token)
      => (await _context.Films.FindAsync(id, token))?.ToDomain();

    public async Task<Film?> GetByTitleAsync(string title, CancellationToken token)
        => (await _context.Films.FirstOrDefaultAsync(f => EF.Functions.ILike(f.Title, $"%{title}%")))?.ToDomain();

    public async IAsyncEnumerable<Film> GetAllAsync([EnumeratorCancellation] CancellationToken token)
    {
        await foreach (var film in _context.Films)
        {
            yield return film.ToDomain();
        }
    }

    public async Task<Film?> CreateAsync(Film entity, CancellationToken token)
    {
        DbFilm dbFilm = entity.ToDb(_context);

        await _context.Films.AddAsync(dbFilm, token);
        await _uow.SaveChangesAsync(token);
        return entity;
    }

    public async Task<bool> DeleteAsync(Guid id, CancellationToken token)
    {
        var film = await _context.Films.FindAsync(id, token);

        if (film is null) return false;

        _context.Films.Remove(film);
        await _uow.SaveChangesAsync(token);
        return true;
    }

    public async Task<Film?> UpdateAsync(Film film, CancellationToken token)
    {
        var dbFilm = await _context.Films.FindAsync(film.Id, token);

        if (dbFilm is null) return null;

        dbFilm.Duration = film.Duration;
        dbFilm.Price = film.Price;
        dbFilm.Title = film.Title;

        await _uow.SaveChangesAsync(token);

        return film;
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Repositories\HallRepository.cs
`$lang
using Cinema.Domain.Entities;
using Cinema.Infrastructure.DbEntities;
using Cinema.Application.Abstractions.IRepositories;
using static Cinema.Infrastructure.Helpers.HallHelpers;
using System.Runtime.CompilerServices;
using Cinema.Infrastructure.Helpers;
using Cinema.Application.Abstractions;

namespace Cinema.Infrastructure.Repositories;

public class HallRepository : IHallRepository
{
    private readonly AppDbContext _context;
    private readonly IUnitOfWork _uow;

    public HallRepository(AppDbContext context, IUnitOfWork uow)
    {
        _context = context;
        _uow = uow;
    }

    public async Task<Hall?> GetByIdAsync(Guid id, CancellationToken token)
        => (await _context.Halls.FindAsync(id, token))?.ToDomain();

    public async IAsyncEnumerable<Hall> GetAllAsync([EnumeratorCancellation] CancellationToken token)
    {
        await foreach (var hall in _context.Halls)
        {
            yield return hall.ToDomain();
        }
    }

    public async Task<Hall?> CreateAsync(Hall entity, CancellationToken token)
    {
        DbHall dbHall = entity.ToDb(_context);

        await _context.Halls.AddAsync(dbHall, token);
        await _uow.SaveChangesAsync(token);
        return entity;
    }

    public async Task<bool> DeleteAsync(Guid id, CancellationToken token)
    {
        var hall = await _context.Halls.FindAsync(id, token);

        if (hall is null) return false;

        _context.Halls.Remove(hall);

        await _uow.SaveChangesAsync(token);
        return true;
    }

    public async Task<Hall?> UpdateAsync(Hall hall, CancellationToken token)
    {
        var dbHall = await _context.Halls.FindAsync(hall.Id, token);

        if (dbHall is null) return null;

        dbHall.Title = hall.Title;
        await _uow.SaveChangesAsync();
        return hall;
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Repositories\SeatRepository.cs
`$lang
using Cinema.Domain.Entities;
using Cinema.Infrastructure.DbEntities;
using Cinema.Application.Abstractions.IRepositories;
using static Cinema.Infrastructure.Helpers.SeatHelpers;
using System.Runtime.CompilerServices;
using Microsoft.EntityFrameworkCore;
using Cinema.Infrastructure.Helpers;
using Cinema.Application.Abstractions;

namespace Cinema.Infrastructure.Repositories;

public class SeatRepository : ISeatRepository
{
    private readonly AppDbContext _context;
    private readonly IUnitOfWork _uow;

    public SeatRepository(AppDbContext context, IUnitOfWork uow)
    {
        _context = context;
        _uow = uow;
    }

    public async Task<Seat?> GetByIdAsync(Guid id, CancellationToken token)
        => (await _context.Seats.FindAsync(id, token))?.ToDomain();

    public async IAsyncEnumerable<Seat> GetAllAsync([EnumeratorCancellation] CancellationToken token)
    {
        await foreach (var seat in _context.Seats)
        {
            yield return seat.ToDomain();
        }
    }

    public async IAsyncEnumerable<Seat> GetByHallIdAsync(Guid id, [EnumeratorCancellation] CancellationToken token)
    {
        await foreach (var seat in _context.Seats.Where(s => s.HallId == id).OrderByDescending(s => s.Raw).ThenByDescending(s => s.Num).AsAsyncEnumerable())
        {
            yield return seat.ToDomain();
        }
    }

    public async Task<Seat?> CreateAsync(Seat entity, CancellationToken token)
    {
        DbSeat dbSeat = entity.ToDb(_context);

        await _context.Seats.AddAsync(dbSeat, token);
        await _uow.SaveChangesAsync(token);
        return entity;
    }

    public async Task<bool> DeleteAsync(Guid id, CancellationToken token)
    {
        var seat = await _context.Seats.FindAsync(id, token);

        if (seat is null) return false;

        _context.Seats.Remove(seat);
        await _uow.SaveChangesAsync(token);
        return true;
    }

    public async Task<Seat?> UpdateAsync(Seat seat, CancellationToken token)
    {
        var dbSeat = await _context.Seats.FindAsync(seat.Id, token);

        if (dbSeat is null) return null;

        dbSeat.HallId = seat.HallId;
        dbSeat.Num = seat.Position.Num;
        dbSeat.Raw = seat.Position.Raw;
        dbSeat.IsOccupied = seat.IsOccupied;

        await _uow.SaveChangesAsync(token);

        return seat;
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Repositories\SessionRepository.cs
`$lang
using Cinema.Domain.Entities;
using Cinema.Infrastructure.DbEntities;
using Cinema.Application.Abstractions.IRepositories;
using static Cinema.Infrastructure.Helpers.SessionHelpers;
using System.Runtime.CompilerServices;
using Microsoft.EntityFrameworkCore;
using Cinema.Infrastructure.Helpers;
using Cinema.Application.Abstractions;

namespace Cinema.Infrastructure.Repositories;

public class SessionRepository : ISessionRepository
{
    private readonly AppDbContext _context;
    private readonly IUnitOfWork _uow;

    public SessionRepository(AppDbContext context, IUnitOfWork uow)
    {
        _context = context;
        _uow = uow;
    }

    public async Task<Session?> GetByIdAsync(Guid id, CancellationToken token)
        => (await _context.Sessions.FindAsync(id, token))?.ToDomain();

    public async Task<Session?> GetByIdWithNavigationPropertyAsync(Guid id, CancellationToken token)
    {
        return (await _context.Sessions
                                .Include(s => s.Hall)
                                  .ThenInclude(h => h!.Seats)
                                .Include(s => s.Film)
                                .FirstOrDefaultAsync(s => s.Id == id))?
                                .ToDomain();
    }

    public async IAsyncEnumerable<Session> GetByHallIdAsync(Guid id, [EnumeratorCancellation] CancellationToken token)
    {
        await foreach (var session in _context.Sessions.Include(s => s.Film).Where(s => s.HallId == id).AsAsyncEnumerable())
        {
            yield return session.ToDomain();
        }
    }

    public async IAsyncEnumerable<Session> GetAllAsync([EnumeratorCancellation] CancellationToken token)
    {
        await foreach (var session in _context.Sessions.Include(s => s.Film).AsAsyncEnumerable())
        {
            yield return session.ToDomain();
        }
    }

    public async Task<Session?> CreateAsync(Session entity, CancellationToken token)
    {
        DbSession dbSession = entity.ToDb(_context);

        await _context.Sessions.AddAsync(dbSession, token);

        await _uow.SaveChangesAsync(token);
        return entity;
    }

    public async Task<bool> DeleteAsync(Guid id, CancellationToken token)
    {
        var session = await _context.Sessions.FindAsync(id, token);

        if (session is null) return false;

        _context.Sessions.Remove(session);

        await _uow.SaveChangesAsync(token);

        return true;
    }

    public async Task<Session?> UpdateAsync(Session session, CancellationToken token)
    {
        var dbSession = await _context.Sessions.FindAsync(session.Id, token);

        if (dbSession is null) return null;

        dbSession.HallId = session.HallId;
        dbSession.FilmId = session.FilmId;

        await _uow.SaveChangesAsync(token);
        return session;
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Repositories\UserRepository.cs
`$lang
using Cinema.Domain.Entities;
using Cinema.Infrastructure.DbEntities;
using Cinema.Application.Abstractions.IRepositories;
using static Cinema.Infrastructure.Helpers.UserHelpers;
using System.Runtime.CompilerServices;
using Microsoft.EntityFrameworkCore;
using Cinema.Infrastructure.Helpers;
using Cinema.Application.Abstractions;

namespace Cinema.Infrastructure.Repositories;

public class UserRepository : IUserRepository
{
    private readonly AppDbContext _context;
    private readonly IUnitOfWork _uow;

    public UserRepository(AppDbContext context, IUnitOfWork uow)
    {
        _context = context;
        _uow = uow;
    }

    public async Task<User?> GetByIdAsync(Guid id, CancellationToken token)
        => (await _context.Users.FindAsync(id, token))?.ToDomain();

    public async Task<User?> GetByEmailAsync(string email, CancellationToken token)
        => (await _context.Users.FirstOrDefaultAsync(u => EF.Functions.ILike(u.Email, $"%{email}%")))?.ToDomain();

    public async Task<User?> GetByIdWithNavigationPropertyAsync(Guid id, CancellationToken token)
        => (await _context.Users
                    .Include(u => u.Bookings)
                        .ThenInclude(b => b.Seats)
                    .Include(u => u.Bookings)
                        .ThenInclude(b => b.Session)
                    .FirstOrDefaultAsync(u => u.Id == id))
                    ?.ToDomain();

    public async IAsyncEnumerable<User> GetAllAsync([EnumeratorCancellation] CancellationToken token)
    {
        await foreach (var user in _context.Users)
        {
            yield return user.ToDomain();
        }
    }

    public async Task<User?> CreateAsync(User entity, CancellationToken token)
    {
        DbUser dbUser = entity.ToDb(_context);

        await _context.Users.AddAsync(dbUser, token);
        await _uow.SaveChangesAsync(token);
        return entity;
    }

    public async Task<bool> DeleteAsync(Guid id, CancellationToken token)
    {
        var user = await _context.Users.FindAsync(id, token);

        if (user is null) return false;

        _context.Users.Remove(user);
        await _uow.SaveChangesAsync(token);
        return true;
    }


    public async Task<User?> UpdateAsync(User user, CancellationToken token)
    {
        var dbUser = await _context.Users.FindAsync(user.Id, token);

        if (dbUser is null) return null;

        var toAdd = BookingsToAdd(user.ToDb(_context), dbUser);
        var toRemove = BookingsToRemove(user.ToDb(_context), dbUser);

        dbUser.Bookings.RemoveAll(s => toRemove.Contains(s));
        dbUser.Bookings.AddRange(toAdd);

        dbUser.Name = user.Name;
        dbUser.PasswordHash = user.PasswordHash;
        dbUser.WalletBalance = user.Wallet.Balance;
        await _uow.SaveChangesAsync(token);
        return user;
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Security\PasswordHasher.cs
`$lang
using Cinema.Application.Abstractions;

namespace Cinema.Infrastructure.Security;

public class PasswordHasher : IPasswordHasher
{
    public string Hash(string password) => BCrypt.Net.BCrypt.HashPassword(password);

    public bool Verify(string password, string passwordHash) => BCrypt.Net.BCrypt.Verify(password, passwordHash);
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Security\Auth\JwtSettings.cs
`$lang
namespace Cinema.Infrastructure.Security.Auth;

public class JwtSettings
{
    public string Secret { get; init; } = null!;
    public string Issuer { get; init; } = null!;
    public string Audience { get; init; } = null!;
    public int ExpiryMinutes { get; init; }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Security\Auth\JwtTokenGenerator.cs
`$lang
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;
using Microsoft.Extensions.Options;
using Microsoft.IdentityModel.Tokens;
using Cinema.Application.Abstractions;
using Cinema.Domain.Enums;

namespace Cinema.Infrastructure.Security.Auth;

public class JwtTokenGenerator : IJwtTokenGenerator
{
    private readonly JwtSettings _jwtSettings;

    public JwtTokenGenerator(IOptions<JwtSettings> jwtOptions)
    {
        _jwtSettings = jwtOptions.Value;
    }

    public Task<string> GenerateToken(Guid userId, string name, string email, Role role)
    {
        var claims = new[]
        {
            new Claim(ClaimTypes.NameIdentifier, userId.ToString()),
            new Claim(ClaimTypes.Name, name),
            new Claim(JwtRegisteredClaimNames.Email, email),
            new Claim(ClaimTypes.Role, role.ToString()),
            new Claim(JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString())
        };

        var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_jwtSettings.Secret));
        var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

        var token = new JwtSecurityToken(
            issuer: _jwtSettings.Issuer,
            audience: _jwtSettings.Audience,
            claims: claims,
            expires: DateTime.UtcNow.AddMinutes(_jwtSettings.ExpiryMinutes),
            signingCredentials: creds
        );

        return Task.FromResult(new JwtSecurityTokenHandler().WriteToken(token));
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Time\FixedClock.cs
`$lang
using Cinema.Domain.Abstractions;

namespace Cinema.Infrastructure.Time;

public class FixedTime : IClock
{
    private readonly DateTime _now;

    public DateTime Now => _now;

    public FixedTime(DateTime time)
    {
        _now = time;
    }
}

`

## File: C:\Users\Agony\Documents\MyProjects\Cinema\src\Infrastructure\Time\SystemClock.cs
`$lang
using Cinema.Domain.Abstractions;

namespace Cinema.Infrastructure.Time;

public class SystemClock : IClock
{
    public DateTime Now => DateTime.UtcNow;

}

`

